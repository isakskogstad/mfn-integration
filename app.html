<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MFN Explorer â€” Nordiska pressmeddelanden</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --bg: #0f1117;
        --bg-card: #1a1d27;
        --bg-card-hover: #222632;
        --bg-input: #12141c;
        --border: #2a2e3a;
        --border-focus: #4a6cf7;
        --text: #e2e5ed;
        --text-muted: #8b90a0;
        --text-heading: #f0f2f7;
        --accent: #4a6cf7;
        --accent-hover: #5b7af8;
        --green: #34d399;
        --green-bg: rgba(52, 211, 153, 0.12);
        --red: #f87171;
        --red-bg: rgba(248, 113, 113, 0.12);
        --yellow: #fbbf24;
        --yellow-bg: rgba(251, 191, 36, 0.12);
        --purple: #a78bfa;
        --purple-bg: rgba(167, 139, 250, 0.12);
        --cyan: #22d3ee;
        --cyan-bg: rgba(34, 211, 238, 0.12);
        --radius: 8px;
        --radius-lg: 12px;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        --transition: 150ms ease;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.5;
        min-height: 100vh;
      }

      /* ---- LAYOUT ---- */
      .app-header {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        padding: 16px 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .app-logo {
        font-size: 20px;
        font-weight: 700;
        color: var(--accent);
        white-space: nowrap;
      }
      .app-logo .subtitle {
        color: var(--text-muted);
        font-weight: 400;
        font-size: 14px;
        margin-left: 8px;
      }
      .app-logo .version {
        color: var(--text-muted);
        font-weight: 400;
        font-size: 11px;
        margin-left: 6px;
        opacity: 0.6;
      }

      .cors-banner {
        background: var(--yellow-bg);
        border: 1px solid rgba(251, 191, 36, 0.3);
        color: var(--yellow);
        padding: 10px 24px;
        font-size: 13px;
        text-align: center;
        display: none;
      }

      @media (max-width: 640px) {
        .app-header {
          flex-wrap: wrap;
          padding: 12px 16px;
        }
        .app-logo .subtitle {
          display: none;
        }
        .tab-bar {
          order: 1;
          width: 100%;
        }
        .tab-btn {
          padding: 6px 10px;
          font-size: 13px;
        }
        .tab-panel {
          padding: 16px;
        }
        .search-row {
          flex-direction: column;
        }
        .filter-bar {
          flex-direction: column;
          align-items: stretch;
        }
        .filter-bar select {
          width: 100% !important;
          min-width: unset !important;
        }
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }

      .tab-bar {
        display: flex;
        gap: 4px;
        flex: 1;
        overflow-x: auto;
      }
      .tab-btn {
        background: transparent;
        border: none;
        color: var(--text-muted);
        padding: 8px 16px;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        transition: all var(--transition);
      }
      .tab-btn:hover {
        color: var(--text);
        background: rgba(255, 255, 255, 0.05);
      }
      .tab-btn.active {
        color: var(--accent);
        background: rgba(74, 108, 247, 0.1);
      }

      .tab-panel {
        display: none;
        padding: 24px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .tab-panel.active {
        display: block;
        animation: fadeIn 0.2s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(4px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }

      /* ---- SHARED COMPONENTS ---- */
      input[type="text"],
      input[type="url"],
      select {
        background: var(--bg-input);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 10px 14px;
        border-radius: var(--radius);
        font-size: 14px;
        width: 100%;
        transition: border-color var(--transition);
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: var(--border-focus);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 10px 18px;
        border-radius: var(--radius);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition);
        white-space: nowrap;
      }
      .btn:hover {
        background: var(--accent-hover);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn-secondary {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
      }
      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.12);
      }
      .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
      }

      .card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 20px;
        transition: all var(--transition);
      }
      .card:hover {
        border-color: rgba(74, 108, 247, 0.3);
      }
      .card-clickable {
        cursor: pointer;
      }
      .card-clickable:hover {
        background: var(--bg-card-hover);
      }

      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }
      .badge-blue {
        background: rgba(74, 108, 247, 0.15);
        color: var(--accent);
      }
      .badge-green {
        background: var(--green-bg);
        color: var(--green);
      }
      .badge-red {
        background: var(--red-bg);
        color: var(--red);
      }
      .badge-yellow {
        background: var(--yellow-bg);
        color: var(--yellow);
      }
      .badge-purple {
        background: var(--purple-bg);
        color: var(--purple);
      }
      .badge-cyan {
        background: var(--cyan-bg);
        color: var(--cyan);
      }
      .badge-muted {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text-muted);
      }

      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.15);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }
      .spinner-lg {
        width: 32px;
        height: 32px;
        border-width: 3px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-center {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 60px;
        gap: 12px;
        color: var(--text-muted);
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
      }
      .empty-state .icon {
        font-size: 40px;
        margin-bottom: 12px;
        opacity: 0.5;
      }
      .empty-state h3 {
        color: var(--text);
        margin-bottom: 8px;
      }

      .error-msg {
        background: var(--red-bg);
        border: 1px solid rgba(248, 113, 113, 0.3);
        color: var(--red);
        padding: 12px 16px;
        border-radius: var(--radius);
        font-size: 14px;
        margin-bottom: 16px;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 16px;
      }
      @media (max-width: 768px) {
        .grid-2,
        .grid-3 {
          grid-template-columns: 1fr;
        }
      }

      .flex-row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .flex-wrap {
        flex-wrap: wrap;
      }
      .flex-col {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .gap-sm {
        gap: 8px;
      }
      .gap-lg {
        gap: 20px;
      }
      .mt-sm {
        margin-top: 8px;
      }
      .mt {
        margin-top: 16px;
      }
      .mt-lg {
        margin-top: 24px;
      }
      .mb {
        margin-bottom: 16px;
      }

      h2 {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-heading);
        margin-bottom: 16px;
      }
      h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-heading);
      }
      .text-muted {
        color: var(--text-muted);
      }
      .text-sm {
        font-size: 13px;
      }
      .text-xs {
        font-size: 11px;
      }
      .mono {
        font-family: "JetBrains Mono", "SF Mono", "Fira Code", monospace;
      }

      .search-row {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
      }
      .search-row input {
        flex: 1;
      }

      .company-logo {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        object-fit: contain;
        background: #fff;
        flex-shrink: 0;
      }
      .company-logo-lg {
        width: 56px;
        height: 56px;
        border-radius: 8px;
      }

      .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }

      /* ---- NEWS ITEM ---- */
      .news-item {
        margin-bottom: 12px;
      }
      .news-item .news-header {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }
      .news-item .news-meta {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 6px;
      }
      .news-item .news-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-heading);
        margin-bottom: 4px;
      }
      .news-item .news-company {
        font-size: 13px;
        color: var(--accent);
      }
      .news-item .news-date {
        font-size: 12px;
        color: var(--text-muted);
      }
      .news-expanded {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
      }
      .news-expanded .preamble {
        font-size: 14px;
        color: var(--text);
        line-height: 1.7;
        margin-bottom: 12px;
        font-style: italic;
      }
      .news-expanded .body-content {
        font-size: 14px;
        line-height: 1.7;
        color: var(--text-muted);
      }
      .news-expanded .body-content strong {
        color: var(--text);
      }
      .news-expanded .attachments {
        margin-top: 12px;
      }
      .news-expanded .attachment-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(255, 255, 255, 0.05);
        padding: 8px 12px;
        border-radius: var(--radius);
        color: var(--accent);
        text-decoration: none;
        font-size: 13px;
        margin-right: 8px;
        margin-bottom: 8px;
        transition: background var(--transition);
      }
      .news-expanded .attachment-link:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .news-regulatory {
        border-left: 3px solid var(--yellow);
      }

      /* ---- FILTER BAR ---- */
      .filter-bar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 16px;
        align-items: center;
      }
      .filter-bar label {
        font-size: 13px;
        color: var(--text-muted);
        margin-right: 4px;
      }
      .filter-bar select {
        width: auto;
        min-width: 120px;
      }

      /* ---- CONTACT EXTRACTION ---- */
      .contact-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px;
      }
      .contact-card .contact-name {
        font-weight: 600;
        color: var(--text-heading);
        font-size: 15px;
      }
      .contact-card .contact-role {
        color: var(--purple);
        font-size: 13px;
        margin-top: 2px;
      }
      .contact-card .contact-detail {
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 4px;
      }
      .contact-card .contact-detail a {
        color: var(--accent);
        text-decoration: none;
      }
      .contact-card .contact-detail a:hover {
        text-decoration: underline;
      }

      .section-block {
        background: rgba(255, 255, 255, 0.02);
        border-left: 3px solid var(--border);
        padding: 12px 16px;
        border-radius: 0 var(--radius) var(--radius) 0;
        margin-bottom: 12px;
      }
      .section-block h4 {
        color: var(--text-heading);
        font-size: 14px;
        margin-bottom: 6px;
      }
      .section-block p {
        font-size: 13px;
        line-height: 1.6;
        color: var(--text-muted);
        white-space: pre-wrap;
      }

      /* ---- MATCHES TABLE ---- */
      .matches-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      .matches-table th {
        text-align: left;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.04);
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
      }
      .matches-table td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        vertical-align: middle;
      }
      .matches-table tr {
        transition: background var(--transition);
        cursor: pointer;
      }
      .matches-table tbody tr:hover {
        background: var(--bg-card-hover);
      }

      /* ---- TOOLS ---- */
      .tool-section {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 16px;
      }
      .tool-section h3 {
        margin-bottom: 12px;
      }

      .url-output {
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 10px 14px;
        font-family: monospace;
        font-size: 13px;
        word-break: break-all;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }
      .url-output a {
        color: var(--accent);
        text-decoration: none;
        flex: 1;
      }
      .url-output a:hover {
        text-decoration: underline;
      }

      .ws-log {
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 12px;
        max-height: 400px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
        line-height: 1.6;
      }
      .ws-log .ws-item {
        padding: 4px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      }
      .ws-log .ws-time {
        color: var(--text-muted);
      }
      .ws-log .ws-title {
        color: var(--text);
      }

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
      }
      .stat-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        text-align: center;
      }
      .stat-card .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--accent);
      }
      .stat-card .stat-label {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      .image-preview {
        max-width: 300px;
        max-height: 200px;
        border-radius: var(--radius);
        margin-top: 12px;
        border: 1px solid var(--border);
      }

      .ws-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
      }
      .ws-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-muted);
      }
      .ws-dot.connected {
        background: var(--green);
      }
      .ws-dot.connecting {
        background: var(--yellow);
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="app-logo">
        MFN Explorer <span class="subtitle">Nordiska pressmeddelanden</span
        ><span class="version">v1.0</span>
      </div>
      <nav class="tab-bar">
        <button class="tab-btn active" data-tab="search">S&ouml;k bolag</button>
        <button class="tab-btn" data-tab="feed">Nyhetsfl&ouml;de</button>
        <button class="tab-btn" data-tab="extract">Kontaktextraktion</button>
        <button class="tab-btn" data-tab="matches">Matchade bolag</button>
        <button class="tab-btn" data-tab="tools">Kalender &amp; Verktyg</button>
      </nav>
    </header>
    <div class="cors-banner" id="cors-banner">
      OBS: Denna app h&auml;mtar data fr&aring;n mfn.se. Om du &ouml;ppnar filen
      direkt fr&aring;n disk (file://) kan CORS-restriktioner blockera
      API-anrop. Anv&auml;nd en lokal webbserver (t.ex.
      <code>npx serve .</code> eller <code>python3 -m http.server</code>)
      f&ouml;r full funktionalitet.
    </div>

    <!-- TAB 1: SOK BOLAG -->
    <div id="tab-search" class="tab-panel active">
      <h2>S&ouml;k bolag</h2>
      <div class="search-row">
        <input
          type="text"
          id="company-search"
          placeholder="S&ouml;k p&aring; bolagsnamn, ticker eller ISIN..."
          autofocus
        />
        <button class="btn" onclick="doCompanySearch()">S&ouml;k</button>
      </div>
      <div id="search-results"></div>
    </div>

    <!-- TAB 2: NYHETSFLODE -->
    <div id="tab-feed" class="tab-panel">
      <div
        class="flex-row mb"
        style="justify-content: space-between; flex-wrap: wrap"
      >
        <h2 id="feed-title" style="margin-bottom: 0">Nyhetsfl&ouml;de</h2>
        <div class="flex-row gap-sm">
          <button class="btn btn-secondary btn-sm" onclick="loadNordicFeed()">
            Nordiskt fl&ouml;de
          </button>
          <button
            class="btn btn-secondary btn-sm"
            id="load-more-btn"
            onclick="loadMoreNews()"
            style="display: none"
          >
            Ladda fler
          </button>
        </div>
      </div>
      <div class="filter-bar">
        <label>Spr&aring;k:</label>
        <select id="filter-lang" onchange="applyFilters()">
          <option value="">Alla</option>
          <option value="sv">Svenska</option>
          <option value="en">English</option>
        </select>
        <label>Typ:</label>
        <select id="filter-type" onchange="applyFilters()">
          <option value="">Alla</option>
          <option value="ir">Regulatorisk (IR)</option>
          <option value="pr">Pressmeddelande (PR)</option>
        </select>
      </div>
      <div id="feed-results"></div>
    </div>

    <!-- TAB 3: KONTAKTEXTRAKTION -->
    <div id="tab-extract" class="tab-panel">
      <h2>Kontaktextraktion</h2>
      <div id="extract-empty" class="empty-state">
        <div class="icon">&#128196;</div>
        <h3>Ingen nyhet vald</h3>
        <p>
          Klicka p&aring; en nyhet i Nyhetsfl&ouml;de-fliken f&ouml;r att
          extrahera kontaktinformation.
        </p>
      </div>
      <div id="extract-content" style="display: none"></div>
    </div>

    <!-- TAB 4: MATCHADE BOLAG -->
    <div id="tab-matches" class="tab-panel">
      <h2>
        Matchade bolag <span class="badge badge-blue" id="match-count">62</span>
      </h2>
      <div class="search-row">
        <input
          type="text"
          id="match-search"
          placeholder="Filtrera p&aring; namn, ticker, orgnummer..."
          oninput="filterMatches()"
        />
        <select
          id="match-exchange"
          onchange="filterMatches()"
          style="width: auto; min-width: 140px"
        >
          <option value="">Alla b&ouml;rser</option>
        </select>
        <select
          id="match-source"
          onchange="filterMatches()"
          style="width: auto; min-width: 160px"
        >
          <option value="">Alla k&auml;llor</option>
          <option value="WatchedCompany">WatchedCompany</option>
          <option value="FamilyOffice">FamilyOffice</option>
        </select>
      </div>
      <div style="overflow-x: auto">
        <table class="matches-table">
          <thead>
            <tr>
              <th>DB-namn</th>
              <th>MFN-namn</th>
              <th>Slug</th>
              <th>Tickers</th>
              <th>Orgnummer</th>
              <th>Matchtyp</th>
              <th>K&auml;llor</th>
            </tr>
          </thead>
          <tbody id="matches-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- TAB 5: KALENDER & VERKTYG -->
    <div id="tab-tools" class="tab-panel">
      <h2>Kalender &amp; Verktyg</h2>

      <div class="tool-section">
        <h3>Entitetsr&auml;knare</h3>
        <p class="text-sm text-muted mb">
          H&auml;mta alla MFN-entiteter och visa statistik.
        </p>
        <button class="btn" id="entity-count-btn" onclick="fetchEntityCount()">
          H&auml;mta alla entiteter
        </button>
        <div id="entity-stats" class="mt" style="display: none"></div>
      </div>

      <div class="tool-section">
        <h3>RSS / Atom / JSON-fl&ouml;desl&auml;nkarna</h3>
        <p class="text-sm text-muted mb">
          Ange en slug f&ouml;r att generera klickbara feed-URL:er.
        </p>
        <div class="search-row">
          <input
            type="text"
            id="feed-slug-input"
            placeholder="T.ex. duni, volvo, climeon..."
          />
          <button class="btn" onclick="generateFeedUrls()">Generera</button>
        </div>
        <div id="feed-urls"></div>
      </div>

      <div class="tool-section">
        <h3>Storage URL-byggare</h3>
        <p class="text-sm text-muted mb">
          Ange en storage.mfn.se-URL, v&auml;lj storlek och f&ouml;rhandsvisa
          bilden.
        </p>
        <div class="search-row">
          <input
            type="url"
            id="storage-url-input"
            placeholder="https://storage.mfn.se/..."
          />
          <select id="storage-size" style="width: auto; min-width: 130px">
            <option value="">Original</option>
            <option value="w-512" selected>512px</option>
            <option value="w-1024">1024px</option>
            <option value="w-2048">2048px</option>
          </select>
          <button class="btn" onclick="buildStorageUrl()">Bygg URL</button>
        </div>
        <div id="storage-result"></div>
      </div>

      <div class="tool-section">
        <h3>WebSocket &mdash; Realtidsfl&ouml;de</h3>
        <p class="text-sm text-muted mb">
          Anslut till MFN:s nordiska WebSocket f&ouml;r live-uppdateringar.
        </p>
        <div class="flex-row gap-sm mb">
          <button class="btn" id="ws-connect-btn" onclick="toggleWebSocket()">
            Anslut
          </button>
          <div class="ws-status">
            <span class="ws-dot" id="ws-dot"></span>
            <span id="ws-status-text">Fr&aring;nkopplad</span>
          </div>
        </div>
        <div class="ws-log" id="ws-log" style="display: none"></div>
      </div>
    </div>

    <script>
      // =============================================================================
      // EMBEDDED MATCH DATA (62 companies)
      // =============================================================================
      const MFN_MATCHES = [
        {
          db_name: "Agtira AB",
          orgNumber: "559033-7654",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Agtira",
          mfn_entity_id: "6772b210-accd-45b6-83a3-b5880548554c",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "agtira",
          mfn_tickers: ["FNSE:AGTIRA B"],
          mfn_isins: ["SE0008588354"],
        },
        {
          db_name: "Arjo AB (publ)",
          orgNumber: "559092-8064",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Arjo",
          mfn_entity_id: "b1688b29-8069-42cd-a151-26f3c25fb314",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "arjo",
          mfn_tickers: ["XSTO:ARJO B", "XLON:0HQ8"],
          mfn_isins: ["SE0010468116"],
        },
        {
          db_name: "Avsalt AB",
          orgNumber: "559199-3661",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Avsalt Group",
          mfn_entity_id: "f5dee7bb-b8b5-41dd-a9fb-73fafd4fbd3a",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "avsalt-group",
          mfn_tickers: ["NSME:AVSALT"],
          mfn_isins: ["SE0022242681"],
        },
        {
          db_name: "Bioextrax AB (publ)",
          orgNumber: "556965-1473",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Bioextrax",
          mfn_entity_id: "6c5dcc45-aa20-4e1a-9a7c-fcd7579ecf03",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "bioextrax",
          mfn_tickers: ["FNSE:BIOEX", "CAPA:BIOEXs"],
          mfn_isins: ["SE0016276752"],
        },
        {
          db_name: "Biofrigas Sweden AB (publ)",
          orgNumber: "556902-2881",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Biofrigas",
          mfn_entity_id: "15abfbb4-3d68-4fe1-9660-cb7d5eb534de",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "biofrigas",
          mfn_tickers: ["XSAT:BIOF"],
          mfn_isins: ["SE0014262887"],
        },
        {
          db_name: "BoMill AB",
          orgNumber: "556556-4332",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "BoMill",
          mfn_entity_id: "03059498-fd6e-44c9-8819-7159558f9686",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "bomill",
          mfn_tickers: ["FNSE:BOMILL", "CAPA:BOMILs"],
          mfn_isins: ["SE0014583332"],
        },
        {
          db_name: "Bure Equity",
          orgNumber: "556454-8781",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "normalized",
          mfn_name: "Bure Equity AB",
          mfn_entity_id: "448ddd85-ea99-42a7-9f3d-6b124dad8218",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "bure-equity",
          mfn_tickers: ["XSTO:BURE", "CAPA:BUREs", "XLON:0N7D"],
          mfn_isins: ["SE0000195810"],
        },
        {
          db_name: "Byggmastare AJ Ahlstrom",
          orgNumber: "556943-7774",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "fuzzy",
          mfn_name: "Byggmastare Anders J Ahlstrom Holding",
          mfn_entity_id: "e2dfa7e6-0903-440c-b01a-c5a0ebf5cbc2",
          mfn_ticker: null,
          mfn_exchange: null,
          fuzzy_score: 0.885,
          mfn_slug: "byggmastare-anders-j-ahlstrom-holding",
          mfn_tickers: ["XSTO:AJA B", "CAPA:AJABs"],
          mfn_isins: ["SE0026876476"],
        },
        {
          db_name: "Byhmgard AB",
          orgNumber: "559335-3773",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Byhmgard",
          mfn_entity_id: "ee4bae61-2150-40ec-9d1a-575f6bffdd17",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "byhmgard",
          mfn_tickers: ["NSME:BESS"],
          mfn_isins: ["SE0023849583"],
        },
        {
          db_name: "C100 AB (publ)",
          orgNumber: "559074-4313",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "C100",
          mfn_entity_id: "1591f5be-ee47-465e-8837-9e0b147b5c5a",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "c100",
          mfn_tickers: ["XSAT:C100"],
          mfn_isins: ["SE0017616006"],
        },
        {
          db_name: "Cinis Fertilizer AB",
          orgNumber: "559154-0322",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Cinis Fertilizer",
          mfn_entity_id: "f742d533-f091-4e65-a37f-a7df33b25ad8",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "cinis-fertilizer",
          mfn_tickers: ["FNSE:CINIS", "CAPA:CINISs"],
          mfn_isins: ["SE0018040784"],
        },
        {
          db_name: "CirChem AB",
          orgNumber: "556951-7427",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "CirChem",
          mfn_entity_id: "e58aeb30-e62f-437f-a617-d48be513c389",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "circhem",
          mfn_tickers: ["FNSE:CIRCHE", "CAPA:CIRCHs"],
          mfn_isins: ["SE0015193529"],
        },
        {
          db_name: "Clean Motion AB",
          orgNumber: "556788-1825",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Clean Motion",
          mfn_entity_id: "ccccca99-07c3-49a8-bc7e-3a79381052f0",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "clean-motion",
          mfn_tickers: ["FNSE:CLEMO", "CAPA:CLEMOs"],
          mfn_isins: ["SE0008216303"],
        },
        {
          db_name: "Climeon AB (publ)",
          orgNumber: "556846-1643",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Climeon",
          mfn_entity_id: "e0b40489-12e2-4051-83d9-92e177479aa8",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "climeon",
          mfn_tickers: ["FNSE:CLIME B", "XLON:0GHX"],
          mfn_isins: ["SE0023837182"],
        },
        {
          db_name: "Creades",
          orgNumber: "556866-0723",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "exact",
          mfn_name: "Creades",
          mfn_entity_id: "fb2167f5-154e-4c8f-8faf-f97e05f7e260",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "creades",
          mfn_tickers: ["XSTO:CRED A", "CAPA:CREDAs", "XLON:0QI9"],
          mfn_isins: ["SE0015661236"],
        },
        {
          db_name: "Creturner Group AB (publ)",
          orgNumber: "559152-3013",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Creturner",
          mfn_entity_id: "da54afa6-3e68-435a-a5ae-49b4146e7c9a",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "creturner",
          mfn_tickers: ["NSME:CRET"],
          mfn_isins: ["SE0013460375"],
        },
        {
          db_name: "CTEK AB (publ)",
          orgNumber: "559217-4659",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "CTEK",
          mfn_entity_id: "e62f1df4-2a77-44a2-a737-2e37b7f54580",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "ctek",
          mfn_tickers: ["XSTO:CTEK", "CAPA:CTEKs"],
          mfn_isins: ["SE0016798763"],
        },
        {
          db_name: "CTEK Sweden AB",
          orgNumber: "556540-3234",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "CTEK",
          mfn_entity_id: "e62f1df4-2a77-44a2-a737-2e37b7f54580",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "ctek",
          mfn_tickers: ["XSTO:CTEK", "CAPA:CTEKs"],
          mfn_isins: ["SE0016798763"],
        },
        {
          db_name: "DUG Foodtech AB (publ)",
          orgNumber: "559054-4655",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "DUG Foodtech",
          mfn_entity_id: "9c345ccd-ead8-470f-b4b4-79c86e9a3d34",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "dug-foodtech",
          mfn_tickers: ["FNSE:DUG"],
          mfn_isins: ["SE0013281979"],
        },
        {
          db_name: "Duni AB",
          orgNumber: "556536-7488",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Duni",
          mfn_entity_id: "81ca67a1-632b-450f-9db7-946963f337d1",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "duni",
          mfn_tickers: ["XSTO:DUNI", "CAPA:DUNIs", "XLON:0HR3"],
          mfn_isins: ["SE0000616716"],
        },
        {
          db_name: "Ecoclime Group AB",
          orgNumber: "556902-1800",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Ecoclime Group",
          mfn_entity_id: "84e87bbd-13a1-49c8-85fb-60305f6f7fb8",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "ecoclime-group",
          mfn_tickers: ["NSME:ECC B"],
          mfn_isins: ["SE0012729937"],
        },
        {
          db_name: "EcoRub AB",
          orgNumber: "556438-0284",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "EcoRub",
          mfn_entity_id: "f95f3646-db5e-487c-9f2c-28f8ec9ee3bd",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "ecorub",
          mfn_tickers: ["XSAT:ECO B"],
          mfn_isins: ["SE0003273531"],
        },
        {
          db_name: "Ferroamp AB (publ)",
          orgNumber: "556805-7029",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Ferroamp",
          mfn_entity_id: "181e39e6-9efd-4a51-ace1-6f8a53ab8084",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "ferroamp",
          mfn_tickers: ["FNSE:FERRO", "CAPA:FERROs"],
          mfn_isins: ["SE0012229920"],
        },
        {
          db_name: "Flat Capital",
          orgNumber: "556941-0110",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "normalized",
          mfn_name: "Flat Capital AB (publ)",
          mfn_entity_id: "d2547a69-6c9f-4362-84c5-5f865f10f5e8",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "flatcapital",
          mfn_tickers: ["FNSE:FLAT B", "CAPA:FLATBs"],
          mfn_isins: ["SE0016609846"],
        },
        {
          db_name: "Gomero Group AB",
          orgNumber: "556623-4976",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Gomero Group",
          mfn_entity_id: "f04b73a1-751d-4053-abd7-23c00568e60d",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "gomero-group",
          mfn_tickers: ["XSAT:GOMERO"],
          mfn_isins: ["SE0011167535"],
        },
        {
          db_name: "Greater Than AB",
          orgNumber: "556965-2885",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Greater Than",
          mfn_entity_id: "8a32dd94-37d7-4ddd-b0c8-0ab52b893dfb",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "greater-than",
          mfn_tickers: ["FNSE:GREAT", "CAPA:GREATs"],
          mfn_isins: ["SE0005881554"],
        },
        {
          db_name: "HEXICON AB",
          orgNumber: "556795-9894",
          sources: ["WatchedCompany"],
          match_type: "exact",
          mfn_name: "Hexicon AB",
          mfn_entity_id: "7457764f-216d-47f5-b393-b1445169e0de",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "hexicon",
          mfn_tickers: ["FNSE:HEXI", "CAPA:HEXIs"],
          mfn_isins: ["SE0004898799"],
        },
        {
          db_name: "Humble Group AB",
          orgNumber: "556794-4797",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Humble Group",
          mfn_entity_id: "030869fd-b776-4c2d-864f-ef7749563b24",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "humble-group",
          mfn_tickers: ["XSTO:HUMBLE", "CAPA:HUMBLs"],
          mfn_isins: ["SE0006261046"],
        },
        {
          db_name: "Hybricon AB",
          orgNumber: "556936-2196",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Hybricon",
          mfn_entity_id: "67ff99dc-15b2-450b-8fb5-e7e9028a8b29",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "hybricon",
          mfn_tickers: ["NSME:HYCO"],
          mfn_isins: ["SE0015345897"],
        },
        {
          db_name: "I-Tech AB",
          orgNumber: "556585-9682",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "I-tech",
          mfn_entity_id: "eb7cf689-1860-4422-ab01-ed858f5a3051",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "i-tech",
          mfn_tickers: ["FNSE:ITECH", "CAPA:ITECHs"],
          mfn_isins: ["SE0011167725"],
        },
        {
          db_name: "Insplorion AB",
          orgNumber: "556798-8760",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Insplorion",
          mfn_entity_id: "4dd45bfb-1fed-4439-95ff-80d6ce84fa1f",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "insplorion",
          mfn_tickers: ["FNSE:INSP", "CAPA:INSPs"],
          mfn_isins: ["SE0006994943"],
        },
        {
          db_name: "Latour",
          orgNumber: "556026-3237",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "exact",
          mfn_name: "Latour",
          mfn_entity_id: "7cbfe9cb-a109-486e-a3f1-c33ce8cdb5ed",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "latour",
          mfn_tickers: ["XSTO:LATO B", "CAPA:LATOBs", "XLON:0RQP"],
          mfn_isins: ["SE0010100958"],
        },
        {
          db_name: "Linc",
          orgNumber: "559210-8947",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "normalized",
          mfn_name: "Linc AB",
          mfn_entity_id: "6fb3250d-226b-46fa-8ac8-6d756ffe293c",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "linc-ab",
          mfn_tickers: ["XSTO:LINC", "CAPA:LINCs"],
          mfn_isins: ["SE0015949433"],
        },
        {
          db_name: "LN Future Invest AB",
          orgNumber: "556419-2663",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "LN Future Invest",
          mfn_entity_id: "82630657-54ca-45e4-b226-ff7a10fe63b9",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "ln-future-invest",
          mfn_tickers: ["FNSE:LNFI", "CAPA:LNFIs"],
          mfn_isins: ["SE0014730347"],
        },
        {
          db_name: "Lyckegard Group AB",
          orgNumber: "556757-7597",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Lyckegard Group",
          mfn_entity_id: "8daf41d8-6193-444c-a885-876b7e365c07",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "lyckegard",
          mfn_tickers: ["FNSE:LYGRD"],
          mfn_isins: ["SE0017160575"],
        },
        {
          db_name: "Lyko Group",
          orgNumber: "556975-8229",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "normalized",
          mfn_name: "Lyko Group AB",
          mfn_entity_id: "d9e11522-2f7d-4fd1-8f4b-9eac25d021ce",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "lyko-group",
          mfn_tickers: ["FNSE:LYKO A", "CAPA:LYKOAs"],
          mfn_isins: ["SE0010468918"],
        },
        {
          db_name: "Mantex Aktiebolag",
          orgNumber: "556550-8537",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Mantex",
          mfn_entity_id: "94e8c5f0-4ec9-4639-beaa-dab4616cd47d",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "mantex",
          mfn_tickers: ["FNSE:MANTEX", "CAPA:MANTEs"],
          mfn_isins: ["SE0023467451"],
        },
        {
          db_name: "Metacon AB (publ)",
          orgNumber: "556724-1616",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Metacon",
          mfn_entity_id: "b2233b77-be55-4257-8aea-ebab70d8a63a",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "metacon",
          mfn_tickers: ["FNSE:META", "CAPA:METAs"],
          mfn_isins: ["SE0003086214"],
        },
        {
          db_name: "Midsummer AB",
          orgNumber: "556665-7838",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Midsummer",
          mfn_entity_id: "df4fc81a-de11-49a3-b0b0-cedeca36ec82",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "midsummer",
          mfn_tickers: ["FNSE:MIDS", "CAPA:MIDSs"],
          mfn_isins: ["SE0011281757"],
        },
        {
          db_name: "Minesto AB",
          orgNumber: "556719-4914",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Minesto",
          mfn_entity_id: "bef24d45-e9b1-4798-b8f1-76c4c4cccde8",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "minesto",
          mfn_tickers: ["FNSE:MINEST", "CAPA:MINESs"],
          mfn_isins: ["SE0007578141"],
        },
        {
          db_name: "Modelon AB (publ)",
          orgNumber: "556672-3010",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Modelon AB",
          mfn_entity_id: "07c7a020-b9be-4e5a-96cb-398cb39918ce",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "modelon",
          mfn_tickers: ["FNSE:MODEL", "CAPA:MODELs"],
          mfn_isins: ["SE0023112438"],
        },
        {
          db_name: "Monivent AB",
          orgNumber: "556956-5707",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Monivent",
          mfn_entity_id: "2143d2da-a46f-49ba-a3e9-43d1863c6435",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "monivent",
          mfn_tickers: ["XSAT:MONI"],
          mfn_isins: ["SE0013512282"],
        },
        {
          db_name: "Nattaro Labs AB",
          orgNumber: "556846-8465",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Nattaro Labs",
          mfn_entity_id: "0f238a1e-5696-483c-98b7-d8ffbfd8ae66",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "nattaro-labs",
          mfn_tickers: ["XSAT:NATTA"],
          mfn_isins: ["SE0016844534"],
        },
        {
          db_name: "Nexam Chemical AB",
          orgNumber: "556784-6711",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Nexam Chemical Holding",
          mfn_entity_id: "dab4bce0-29cd-462c-9772-afdb47b39268",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "nexam-chemical-holding",
          mfn_tickers: ["FNSE:NEXAM", "CAPA:NEXAMs"],
          mfn_isins: ["SE0005101003"],
        },
        {
          db_name: "Oresund",
          orgNumber: "556539-8582",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "exact",
          mfn_name: "Oresund",
          mfn_entity_id: "11a3dda7-3314-4d20-8f12-3d421dc35519",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "oresund",
          mfn_tickers: ["XSTO:ORES", "CAPA:ORESs", "XLON:0RGB"],
          mfn_isins: ["SE0008321608"],
        },
        {
          db_name: "OrganoClick AB",
          orgNumber: "556704-6908",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "OrganoClick",
          mfn_entity_id: "912d1f41-c37e-4c46-b044-e0a07c59d4a4",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "organoclick",
          mfn_tickers: ["FNSE:ORGC", "CAPA:ORGCs"],
          mfn_isins: ["SE0006510335"],
        },
        {
          db_name: "Powercell Sweden AB (publ)",
          orgNumber: "556759-8353",
          sources: ["WatchedCompany"],
          match_type: "exact",
          mfn_name: "PowerCell Sweden AB (publ)",
          mfn_entity_id: "05cf9591-3152-4479-bf8d-e60a78178e2e",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "powercell-sweden",
          mfn_tickers: ["XSTO:PCELL", "CAPA:PCELLs", "XLON:0G9R"],
          mfn_isins: ["SE0006425815"],
        },
        {
          db_name: "Prebona AB",
          orgNumber: "556855-5022",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Prebona",
          mfn_entity_id: "eeb34480-ef27-49dc-abc1-df29cf8c2f67",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "prebona",
          mfn_tickers: ["XSAT:PREBON"],
          mfn_isins: ["SE0007692884"],
        },
        {
          db_name: "Recyctec AB",
          orgNumber: "556750-7628",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Recyctec Holding",
          mfn_entity_id: "20633de6-7753-430e-9b03-1c1b2eaeb2b2",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "recyctec-holding",
          mfn_tickers: ["XSAT:RECY B"],
          mfn_isins: ["SE0014808978"],
        },
        {
          db_name: "SaltX Technology Holding AB (publ)",
          orgNumber: "556917-6596",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "SaltX Technology Holding",
          mfn_entity_id: "f2771f71-b2c1-41bd-9c53-7705d0cf3d20",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "saltx-technology-holding",
          mfn_tickers: ["FNSE:SALT B", "CAPA:SALTBs", "XLON:0G6W"],
          mfn_isins: ["SE0005308541"],
        },
        {
          db_name: "Scandinavian Enviro Systems AB",
          orgNumber: "556605-6726",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Scandinavian Enviro Systems AB (publ)",
          mfn_entity_id: "43f3e6a4-3cf4-4770-83dc-816845770e1f",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "scandinavian-enviro-systems",
          mfn_tickers: ["FNSE:SES", "CAPA:SESs"],
          mfn_isins: ["SE0005877560"],
        },
        {
          db_name: "SeaTwirl AB (publ)",
          orgNumber: "556890-1135",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "SeaTwirl",
          mfn_entity_id: "96f5751a-ae16-441d-a892-2f7f526934a6",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "seatwirl",
          mfn_tickers: ["FNSE:STW", "CAPA:STWs"],
          mfn_isins: ["SE0009242175"],
        },
        {
          db_name: "SHT Smart High-Tech Aktiebolag",
          orgNumber: "556077-7434",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "SHT Smart High-Tech",
          mfn_entity_id: "1f35ee24-967c-4138-9ee6-6df83b33df79",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "sht-smart-high-tech",
          mfn_tickers: ["XSAT:SHT B"],
          mfn_isins: ["SE0016843809"],
        },
        {
          db_name: "Smoltek Nanotech Holding AB",
          orgNumber: "559020-2262",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Smoltek Nanotech Holding",
          mfn_entity_id: "bb4ad7ad-d359-4389-b113-99f64ff84603",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "smoltek-nanotech-holding",
          mfn_tickers: ["XSAT:SMOL", "CAPA:SMOLs"],
          mfn_isins: ["SE0010820381"],
        },
        {
          db_name: "Sustainable Energy Solutions Sweden Holding AB",
          orgNumber: "556530-5868",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Sustainable Energy Solutions Sweden Holding",
          mfn_entity_id: "8f2c9e97-1050-4382-9387-b0f511ae5dd6",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "sustainable-energy-solutions-sweden-holding",
          mfn_tickers: ["NSME:SENS"],
          mfn_isins: ["SE0011643980"],
        },
        {
          db_name: "Svenska Aerogel AB",
          orgNumber: "556581-3028",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Svenska Aerogel Holding",
          mfn_entity_id: "dc018f91-f062-4fb3-b093-4798a7b3c568",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "svenska-aerogel-holding",
          mfn_tickers: ["FNSE:AERO", "CAPA:AEROs"],
          mfn_isins: ["SE0023440557"],
        },
        {
          db_name: "Svolder",
          orgNumber: "556469-2019",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "normalized",
          mfn_name: "Svolder AB (publ)",
          mfn_entity_id: "0591da51-7678-40da-a783-47ddb63a6698",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "svolder",
          mfn_tickers: [
            "XSTO:SVOL B",
            "CAPA:SVOLBs",
            "XSTO:SVOL A",
            "CAPA:SVOLAs",
          ],
          mfn_isins: ["SE0017161441", "SE0017161458"],
        },
        {
          db_name: "Traction",
          orgNumber: "556105-1243",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "exact",
          mfn_name: "Traction",
          mfn_entity_id: "551fe57a-5d99-4cb2-98eb-d97a4c860afe",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "traction",
          mfn_tickers: ["XSTO:TRAC B", "CAPA:TRACBs", "XLON:0GOS"],
          mfn_isins: ["SE0000391716"],
        },
        {
          db_name: "Unibap Space Solutions AB (publ)",
          orgNumber: "556925-1134",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Unibap Space Solutions",
          mfn_entity_id: "8a253944-3750-45ab-a596-0cddc602c70c",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "unibap-space-solutions",
          mfn_tickers: ["FNSE:UNIBAP", "CAPA:UNIBAs"],
          mfn_isins: ["SE0009606809"],
        },
        {
          db_name: "Vend Marketplaces AB",
          orgNumber: "556610-3429",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Vend Marketplaces",
          mfn_entity_id: "70ba2154-90b6-447b-bd70-e7464c6c82d3",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "vend-marketplaces",
          mfn_tickers: ["XOSL:VEND", "XLON:0R9I"],
          mfn_isins: ["NO0010736879"],
        },
        {
          db_name: "Voi Technology AB",
          orgNumber: "559160-2999",
          sources: ["WatchedCompany"],
          match_type: "exact",
          mfn_name: "Voi Technology AB",
          mfn_entity_id: "84595893-0285-46d9-af1f-9ba2199a718a",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "voitechnology",
          mfn_tickers: [],
          mfn_isins: ["SE0023134952"],
        },
        {
          db_name: "Xoma AB",
          orgNumber: "559071-5750",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Xoma",
          mfn_entity_id: "2ab3447a-2103-4385-bfd8-35acacd93748",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "xoma",
          mfn_tickers: ["XSAT:XOMA B"],
          mfn_isins: ["SE0019174194"],
        },
      ];

      // =============================================================================
      // STATE
      // =============================================================================
      let currentFeedSlug = null;
      let currentFeedItems = [];
      let allFeedItems = [];
      let currentOffset = 0;
      let expandedNewsId = null;
      let selectedNewsForExtraction = null;
      let wsConnection = null;

      // =============================================================================
      // TAB NAVIGATION
      // =============================================================================
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".tab-btn")
            .forEach((b) => b.classList.remove("active"));
          document
            .querySelectorAll(".tab-panel")
            .forEach((p) => p.classList.remove("active"));
          btn.classList.add("active");
          document
            .getElementById("tab-" + btn.dataset.tab)
            .classList.add("active");
        });
      });

      function switchToTab(name) {
        document.querySelectorAll(".tab-btn").forEach((b) => {
          b.classList.toggle("active", b.dataset.tab === name);
        });
        document.querySelectorAll(".tab-panel").forEach((p) => {
          p.classList.toggle("active", p.id === "tab-" + name);
        });
      }

      // =============================================================================
      // HELPERS
      // =============================================================================
      function esc(s) {
        if (!s) return "";
        const d = document.createElement("div");
        d.textContent = s;
        return d.innerHTML;
      }

      /** Escape for use inside single-quoted JS string in onclick attributes */
      function escJs(s) {
        if (!s) return "";
        return s
          .replace(/\\/g, "\\\\")
          .replace(/'/g, "\\'")
          .replace(/&/g, "&amp;");
      }

      function formatDate(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        return d.toLocaleDateString("sv-SE", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function showLoading(el) {
        el.innerHTML =
          '<div class="loading-center"><div class="spinner spinner-lg"></div><span>Laddar...</span></div>';
      }

      function showError(el, msg) {
        el.innerHTML = `<div class="error-msg">${esc(msg)}</div>`;
      }

      function showEmpty(el, icon, title, desc) {
        el.innerHTML = `<div class="empty-state"><div class="icon">${icon}</div><h3>${esc(
          title
        )}</h3><p>${esc(desc)}</p></div>`;
      }

      function getTagBadgeClass(tag) {
        if (tag === ":regulatory" || tag === "sub:ca") return "badge-yellow";
        if (tag.startsWith("sub:report") || tag === "sub:annual-report")
          return "badge-purple";
        if (tag.startsWith("sub:")) return "badge-cyan";
        if (tag === ":central") return "badge-green";
        return "badge-muted";
      }

      function getMatchTypeBadge(type) {
        if (type === "exact") return "badge-green";
        if (type === "normalized") return "badge-blue";
        if (type === "fuzzy") return "badge-yellow";
        return "badge-muted";
      }

      function getExchange(ticker) {
        if (!ticker) return null;
        const prefix = ticker.split(":")[0];
        const map = {
          XSTO: "Nasdaq Stockholm",
          FNSE: "First North",
          XSAT: "Spotlight",
          NSME: "Nordic SME",
          XOSL: "Oslo Bors",
          XLON: "London",
          CAPA: "Capa",
        };
        return map[prefix] || prefix;
      }

      // =============================================================================
      // TAB 1: COMPANY SEARCH
      // =============================================================================
      const searchInput = document.getElementById("company-search");
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") doCompanySearch();
      });

      let searchDebounce = null;
      searchInput.addEventListener("input", () => {
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => {
          if (searchInput.value.trim().length >= 2) doCompanySearch();
        }, 400);
      });

      async function doCompanySearch() {
        const q = searchInput.value.trim();
        if (!q) return;
        const el = document.getElementById("search-results");
        showLoading(el);
        try {
          const res = await fetch(
            `https://mfn.se/search/companies?limit=10&query=${encodeURIComponent(
              q
            )}`
          );
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const companies = await res.json();
          if (!companies.length) {
            showEmpty(
              el,
              "&#128269;",
              "Inga resultat",
              `Hittade inga bolag f\u00f6r "${q}".`
            );
            return;
          }
          el.innerHTML =
            '<div class="flex-col gap-sm">' +
            companies
              .map((c) => {
                const logo = c.brand_image_url
                  ? `<img class="company-logo" src="${esc(
                      c.brand_image_url
                    )}?size=w-512" alt="" onerror="this.style.display='none'">`
                  : "";
                const tickers = (c.tickers || [])
                  .filter((t) => !t.startsWith("CAPA:"))
                  .map((t) => `<span class="badge badge-blue">${esc(t)}</span>`)
                  .join(" ");
                const isins = (c.isins || [])
                  .map(
                    (i) =>
                      `<span class="badge badge-muted mono">${esc(i)}</span>`
                  )
                  .join(" ");
                const orgs = (c.local_refs || [])
                  .filter((r) => r.startsWith("SE:"))
                  .map(
                    (r) =>
                      `<span class="badge badge-purple mono">${esc(
                        r.replace("SE:", "")
                      )}</span>`
                  )
                  .join(" ");
                return `
        <div class="card card-clickable" onclick="selectCompany('${escJs(
          c.slug
        )}', '${escJs(c.name)}')">
          <div class="flex-row" style="gap:16px;">
            ${logo}
            <div style="flex:1;min-width:0;">
              <div style="font-weight:600;font-size:16px;color:var(--text-heading);">${esc(
                c.name
              )}</div>
              <div class="text-sm text-muted" style="margin-top:2px;">Slug: <span class="mono">${esc(
                c.slug
              )}</span></div>
              <div class="tag-list mt-sm">${tickers} ${isins} ${orgs}</div>
            </div>
          </div>
        </div>`;
              })
              .join("") +
            "</div>";
        } catch (err) {
          showError(el, "Kunde inte s\u00f6ka: " + err.message);
        }
      }

      function selectCompany(slug, name) {
        currentFeedSlug = slug;
        document.getElementById("feed-title").textContent = `Nyheter: ${name}`;
        switchToTab("feed");
        loadCompanyNews(slug);
      }

      // =============================================================================
      // TAB 2: NEWS FEED
      // =============================================================================
      async function loadCompanyNews(slug) {
        const el = document.getElementById("feed-results");
        showLoading(el);
        currentOffset = 0;
        try {
          const res = await fetch(`https://mfn.se/all/a/${slug}.json?limit=20`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          allFeedItems = data.items || [];
          currentFeedItems = allFeedItems;
          currentOffset = allFeedItems.length;
          document.getElementById("load-more-btn").style.display =
            allFeedItems.length >= 20 ? "" : "none";
          applyFilters();
        } catch (err) {
          showError(el, "Kunde inte ladda nyheter: " + err.message);
        }
      }

      async function loadNordicFeed() {
        currentFeedSlug = null;
        document.getElementById("feed-title").textContent =
          "Nordiskt nyhetsfl\u00f6de";
        const el = document.getElementById("feed-results");
        showLoading(el);
        currentOffset = 0;
        try {
          const res = await fetch(
            "https://mfn.se/all/s/nordic.json?limit=20&compact=true"
          );
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          allFeedItems = data.items || [];
          currentFeedItems = allFeedItems;
          currentOffset = allFeedItems.length;
          document.getElementById("load-more-btn").style.display =
            allFeedItems.length >= 20 ? "" : "none";
          applyFilters();
        } catch (err) {
          showError(el, "Kunde inte ladda nordiskt fl\u00f6de: " + err.message);
        }
      }

      async function loadMoreNews() {
        const slug = currentFeedSlug;
        const url = slug
          ? `https://mfn.se/all/a/${slug}.json?limit=20&offset=${currentOffset}`
          : `https://mfn.se/all/s/nordic.json?limit=20&offset=${currentOffset}&compact=true`;
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          const newItems = data.items || [];
          allFeedItems = allFeedItems.concat(newItems);
          currentOffset += newItems.length;
          if (newItems.length < 20)
            document.getElementById("load-more-btn").style.display = "none";
          applyFilters();
        } catch (err) {
          console.error("Load more error:", err);
        }
      }

      function applyFilters() {
        const lang = document.getElementById("filter-lang").value;
        const type = document.getElementById("filter-type").value;
        let items = allFeedItems;
        if (lang) items = items.filter((i) => i.properties?.lang === lang);
        if (type) items = items.filter((i) => i.properties?.type === type);
        currentFeedItems = items;
        renderNewsFeed(items);
      }

      function renderNewsFeed(items) {
        const el = document.getElementById("feed-results");
        if (!items.length) {
          showEmpty(
            el,
            "&#128240;",
            "Inga nyheter",
            "Inga nyheter att visa med valda filter."
          );
          return;
        }
        el.innerHTML = items
          .map((item, idx) => {
            const props = item.properties || {};
            const tags = (props.tags || [])
              .map(
                (t) =>
                  `<span class="badge ${getTagBadgeClass(t)}">${esc(
                    t.replace(/^[:]/, "")
                  )}</span>`
              )
              .join(" ");
            const isReg = (props.tags || []).includes(":regulatory");
            const lang = props.lang || "";
            const author = item.author || {};
            const logoHtml = author.brand_image_url
              ? `<img class="company-logo" src="${esc(
                  author.brand_image_url
                )}?size=w-512" alt="" onerror="this.style.display='none'">`
              : "";
            const isExpanded = expandedNewsId === item.news_id;
            return `
      <div class="card card-clickable news-item ${
        isReg ? "news-regulatory" : ""
      }" style="margin-bottom:12px;" onclick="toggleNewsItem('${
              item.news_id
            }', ${idx})">
        <div class="news-header">
          ${logoHtml}
          <div style="flex:1;min-width:0;">
            <div class="news-title">${esc(item.title)}</div>
            <div class="news-meta">
              <span class="news-company">${esc(author.name || "")}</span>
              <span class="news-date">${formatDate(item.published)}</span>
              <span class="badge ${
                lang === "sv" ? "badge-blue" : "badge-green"
              }">${esc(lang.toUpperCase())}</span>
              ${
                isReg
                  ? '<span class="badge badge-yellow">REGULATORISK</span>'
                  : ""
              }
              ${tags}
            </div>
          </div>
        </div>
        <div id="news-expand-${item.news_id}" style="display:${
              isExpanded ? "block" : "none"
            };">
          ${isExpanded ? renderExpandedNews(item) : ""}
        </div>
      </div>`;
          })
          .join("");
      }

      async function toggleNewsItem(newsId, idx) {
        if (expandedNewsId === newsId) {
          expandedNewsId = null;
          const el = document.getElementById("news-expand-" + newsId);
          if (el) el.style.display = "none";
          return;
        }
        expandedNewsId = newsId;
        const item = currentFeedItems[idx];
        const el = document.getElementById("news-expand-" + newsId);

        // If compact (no content.html), fetch the full version
        if (
          item &&
          (!item.content || !item.content.html) &&
          item.author?.slug
        ) {
          el.innerHTML =
            '<div class="loading-center" style="padding:20px;"><div class="spinner"></div><span>Laddar inneh\u00e5ll...</span></div>';
          el.style.display = "block";
          try {
            const slug = item.author.slug;
            // Fetch the single news item via the company feed (not compact)
            const res = await fetch(
              `https://mfn.se/all/a/${slug}.json?limit=1&query=${encodeURIComponent(
                item.title
              )}`
            );
            if (res.ok) {
              const data = await res.json();
              const found = (data.items || []).find(
                (i) => i.news_id === newsId
              );
              if (found) {
                Object.assign(item, found);
              }
            }
          } catch (e) {
            /* ignore, render what we have */
          }
        }

        if (el) {
          el.innerHTML = renderExpandedNews(item);
          el.style.display = "block";
        }
        // Store for extraction tab
        selectedNewsForExtraction = item;
      }

      function renderExpandedNews(item) {
        if (!item) return "";
        const content = item.content || {};
        let html = '<div class="news-expanded">';

        if (content.preamble) {
          html += `<div class="preamble">${esc(content.preamble)}</div>`;
        }

        if (content.html) {
          html += `<div class="body-content">${content.html}</div>`;
        } else if (content.text) {
          html += `<div class="body-content" style="white-space:pre-wrap;">${esc(
            content.text
          )}</div>`;
        }

        const attachments = content.attachments || [];
        if (attachments.length) {
          html +=
            '<div class="attachments"><strong style="font-size:13px;color:var(--text-muted);">Bilagor:</strong><br>';
          attachments.forEach((a) => {
            const icon = (a.url || "").endsWith(".pdf")
              ? "&#128196;"
              : "&#128248;";
            html += `<a class="attachment-link" href="${esc(
              a.url
            )}" target="_blank" onclick="event.stopPropagation()">${icon} ${esc(
              a.title || a.url?.split("/").pop() || "Bilaga"
            )}</a>`;
          });
          html += "</div>";
        }

        if (content.html) {
          html += `<div class="mt"><button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); extractFromCurrent()">Extrahera kontakter</button></div>`;
        }

        html += "</div>";
        return html;
      }

      function extractFromCurrent() {
        if (!selectedNewsForExtraction) return;
        switchToTab("extract");
        runExtraction(selectedNewsForExtraction);
      }

      // =============================================================================
      // TAB 3: CONTACT EXTRACTION
      // =============================================================================
      function extractMfnContent(html) {
        const stripHtml = (s) =>
          s
            .replace(/<[^>]+>/g, "\n")
            .replace(/&amp;/g, "&")
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&quot;/g, '"')
            .replace(/&#039;/g, "'")
            .replace(/&nbsp;/g, " ")
            .replace(/\n{3,}/g, "\n\n")
            .trim();

        const contacts = [];

        // Strategy 1: mfn-footer mfn-contacts
        const contactFooter = html.match(
          /<div class="mfn-footer mfn-contacts[^"]*">([\s\S]*?)<\/div>\s*(?:\n<div|$)/
        );
        // Strategy 2: generic mfn-footer with hash + contact keywords
        const contactGenericFooter = html.match(
          /<div class="mfn-footer mfn-[a-f0-9]+">[^]*?(?:CONTACT|kontakta|INFORMATION)[^]*?<\/div>/i
        );
        // Strategy 3: bare mfn-footer
        const contactBareFooter = html.match(
          /<div class="mfn-footer">\s*(?:<p>)?\s*(?:<span>)*\s*(?:<span>)*\s*(?:<strong>)?\s*(?:Mediakontakt|Foretagskontakt|Investor Relations|Pressansvarig|Press\s*contact|Media\s*contact|CONTACT|kontakta|INFORMATION)[\s\S]*?<\/div>/i
        );
        // Strategy 4: inline
        const contactInline = html.match(
          /<strong[^>]*>(?:<[^>]+>)*[^<]*(?:kontakt[a-z]*|(?:please )?contact)[^]*?<\/strong>(?:<\/p>)?\s*([\s\S]*?)(?:<div class="mfn-footer|<strong[^>]*class="mfn-heading|$)/i
        );

        const contactSource =
          contactFooter?.[1] ??
          contactGenericFooter?.[0] ??
          contactBareFooter?.[0] ??
          contactInline?.[1] ??
          "";
        const contactBlock = stripHtml(contactSource);

        if (contactBlock) {
          const lines = contactBlock
            .split("\n")
            .map((l) => l.trim())
            .filter(
              (l) =>
                l &&
                l !== "-".repeat(l.length) &&
                l !== "_".repeat(l.length) &&
                !/^(?:FOR MORE|For (?:mer|ytterligare|vidare)|KONTAKT|Contact)/i.test(
                  l
                )
            );

          const emailRe = /^(?:E-?mail:\s*)?[\w.+-]+@[\w.-]+\.\w+$/i;
          const phoneRe = /^(?:Phone:\s*|Tel(?:efon)?:\s*)?[+0][\s()\d-]{7,}/i;
          const isEmail = (s) => emailRe.test(s);
          const isPhone = (s) => phoneRe.test(s);
          const extractEmailFn = (s) => {
            const m = s.match(/([\w.+-]+@[\w.-]+\.\w+)/);
            return m ? m[1] : s;
          };
          const extractPhoneFn = (s) =>
            s.replace(/^(?:Phone|Tel(?:efon)?):\s*/i, "").trim();

          const consumed = new Set();
          for (let i = 0; i < lines.length; i++) {
            if (consumed.has(i)) continue;

            // Pattern A
            const nameTitle =
              lines[i].length <= 200
                ? lines[i].match(/^([A-ZÃ…Ã„Ã–Ã‰ÃˆÃŠ][\wÃ©Ã¨ÃªÃ¥Ã¤Ã¶\s.-]{1,50}),\s*(.+?)$/)
                : null;
            if (nameTitle) {
              const name = nameTitle[1].trim();
              let role = nameTitle[2].trim();
              let email = null,
                phone = null;
              const inlineEmail = role.match(/([\w.+-]+@[\w.-]+\.\w+)/);
              const inlinePhone = role.match(/([+0][\s()\d-]{7,})/);
              if (inlineEmail) {
                email = inlineEmail[1];
                role = role
                  .replace(inlineEmail[0], "")
                  .replace(/,\s*$/, "")
                  .trim();
              }
              if (inlinePhone) {
                phone = inlinePhone[1].trim();
                role = role
                  .replace(inlinePhone[0], "")
                  .replace(/,\s*$/, "")
                  .trim();
              }
              consumed.add(i);
              for (let j = i + 1; j < Math.min(i + 6, lines.length); j++) {
                if (!email && isEmail(lines[j])) {
                  email = extractEmailFn(lines[j]);
                  consumed.add(j);
                } else if (!phone && isPhone(lines[j])) {
                  phone = extractPhoneFn(lines[j]);
                  consumed.add(j);
                } else if (/^(?:E-?mail|Phone|Tel):\s*$/i.test(lines[j]))
                  continue;
                else if (
                  lines[j].match(/^[A-ZÃ…Ã„Ã–]/) &&
                  !isEmail(lines[j]) &&
                  !isPhone(lines[j])
                )
                  break;
              }
              contacts.push({ name, role: role || null, email, phone });
              continue;
            }

            // Pattern B
            if (
              /^(?:Mediakontakt|Foretagskontakt|Investor Relations|Pressansvarig|Press\s*contact|Media\s*contact|Communications?\s*Department)/i.test(
                lines[i]
              )
            ) {
              const dept = lines[i];
              let name = null,
                role = null,
                email = null,
                phone = null;
              consumed.add(i);
              for (let j = i + 1; j < Math.min(i + 6, lines.length); j++) {
                if (isEmail(lines[j])) {
                  email = extractEmailFn(lines[j]);
                  consumed.add(j);
                } else if (isPhone(lines[j])) {
                  phone = extractPhoneFn(lines[j]);
                  consumed.add(j);
                } else if (
                  !name &&
                  /^[A-ZÃ…Ã„Ã–]/.test(lines[j]) &&
                  !isEmail(lines[j]) &&
                  !isPhone(lines[j])
                ) {
                  name = lines[j];
                  consumed.add(j);
                } else if (
                  name &&
                  !role &&
                  !isEmail(lines[j]) &&
                  !isPhone(lines[j]) &&
                  /^(?:CEO|CFO|CTO|COO|VD|VP|Head|Chief|Director|Chef|Kommunikation|Finans)/i.test(
                    lines[j]
                  )
                ) {
                  role = lines[j];
                  consumed.add(j);
                } else if (
                  /^(?:Mediakontakt|Foretagskontakt|Investor|Press)/i.test(
                    lines[j]
                  )
                )
                  break;
              }
              if (name || email)
                contacts.push({
                  name: name || dept,
                  role: role || dept,
                  email,
                  phone,
                });
              continue;
            }

            // Pattern C
            if (
              /^[A-ZÃ…Ã„Ã–Ã‰ÃˆÃŠ][\wÃ©Ã¨ÃªÃ¥Ã¤Ã¶\s.-]+$/.test(lines[i]) &&
              !isEmail(lines[i]) &&
              !isPhone(lines[i]) &&
              i + 1 < lines.length
            ) {
              const nextLine = lines[i + 1];
              const looksLikeRole =
                /(?:VD|CEO|CFO|CTO|COO|VP|Head|Chief|Director|Chef|direktÃ¶r|ansvarig|ordfÃ¶rande|Chairman|Manager|Officer|Investor|Communications|IR\b)/i.test(
                  nextLine
                ) &&
                !isEmail(nextLine) &&
                !isPhone(nextLine);
              if (looksLikeRole) {
                const name = lines[i].trim();
                const role = nextLine.trim();
                let email = null,
                  phone = null;
                consumed.add(i);
                consumed.add(i + 1);
                for (let j = i + 2; j < Math.min(i + 5, lines.length); j++) {
                  if (!email && isEmail(lines[j])) {
                    email = extractEmailFn(lines[j]);
                    consumed.add(j);
                  } else if (!phone && isPhone(lines[j])) {
                    phone = extractPhoneFn(lines[j]);
                    consumed.add(j);
                  } else if (
                    /^[A-ZÃ…Ã„Ã–]/.test(lines[j]) &&
                    !isEmail(lines[j]) &&
                    !isPhone(lines[j])
                  )
                    break;
                }
                contacts.push({ name, role, email, phone });
                continue;
              }
            }

            // Pattern D
            if (
              /^[A-ZÃ…Ã„Ã–Ã‰ÃˆÃŠ]/.test(lines[i]) &&
              !isEmail(lines[i]) &&
              !isPhone(lines[i]) &&
              i + 1 < lines.length &&
              isEmail(lines[i + 1])
            ) {
              const name = lines[i].trim();
              const email = extractEmailFn(lines[i + 1]);
              let phone = null;
              consumed.add(i);
              consumed.add(i + 1);
              if (i + 2 < lines.length && isPhone(lines[i + 2])) {
                phone = extractPhoneFn(lines[i + 2]);
                consumed.add(i + 2);
              }
              contacts.push({ name, role: null, email, phone });
              continue;
            }
          }
        }

        // About Company
        const aboutMatch =
          html.match(
            /<div class="mfn-footer mfn-about[^"]*">([\s\S]*?)<\/div>/
          ) ||
          html.match(
            /<div class="mfn-footer mfn-[a-f0-9]+">\s*(?:<p>)?\s*(?:<strong[^>]*>)?\s*(?:Om |About )[^]*?<\/div>/i
          );
        const aboutCompany = aboutMatch
          ? stripHtml(aboutMatch[1] || aboutMatch[0])
          : null;

        // Regulatory
        const regMatch = html.match(
          /<div class="mfn-footer mfn-regulatory[^"]*">([\s\S]*?)<\/div>/
        );
        const regulatoryDisclosure = regMatch ? stripHtml(regMatch[1]) : null;

        // Certified Adviser
        const text = stripHtml(html);
        const caMatch = text.match(
          /Certified Adviser[:\s]*\n(.*?)(?=\n\n|Om |About |$)/is
        );
        const certifiedAdviser = caMatch ? caMatch[1].trim() : null;

        // Sections
        const sections = [];
        const headingParts = html.split(/<strong class="mfn-heading-[12]">/);
        for (let i = 1; i < headingParts.length; i++) {
          const endTag = headingParts[i].indexOf("</strong>");
          if (endTag === -1) continue;
          const heading = headingParts[i].substring(0, endTag).trim();
          const rest = headingParts[i].substring(endTag);
          const sectionEnd = rest.search(
            /<strong class="mfn-heading|<div class="mfn-footer/
          );
          const sectionHtml =
            sectionEnd > 0 ? rest.substring(0, sectionEnd) : rest;
          const sectionText = stripHtml(sectionHtml).replace(/^\s*\n/, "");
          if (sectionText) sections.push({ heading, text: sectionText });
        }

        return {
          contacts,
          aboutCompany,
          certifiedAdviser,
          regulatoryDisclosure,
          sections,
        };
      }

      function runExtraction(item) {
        document.getElementById("extract-empty").style.display = "none";
        const el = document.getElementById("extract-content");
        el.style.display = "block";

        const content = item.content || {};
        if (!content.html) {
          el.innerHTML = `
      <div class="card mb">
        <h3>${esc(item.title)}</h3>
        <p class="text-sm text-muted mt-sm">${esc(
          item.author?.name || ""
        )} â€” ${formatDate(item.published)}</p>
      </div>
      <div class="error-msg">Denna nyhet saknar HTML-inneh\u00e5ll. Kontaktextraktion kr\u00e4ver fullst\u00e4ndig HTML.</div>`;
          return;
        }

        const extracted = extractMfnContent(content.html);

        let html = `
    <div class="card mb">
      <h3>${esc(item.title)}</h3>
      <p class="text-sm text-muted mt-sm">${esc(
        item.author?.name || ""
      )} â€” ${formatDate(item.published)}</p>
    </div>`;

        // Contacts
        html += '<h3 style="margin:20px 0 12px;">Kontakter</h3>';
        if (extracted.contacts.length) {
          html += '<div class="grid-2 mb">';
          extracted.contacts.forEach((c) => {
            html += `<div class="contact-card">
        <div class="contact-name">${esc(c.name)}</div>
        ${c.role ? `<div class="contact-role">${esc(c.role)}</div>` : ""}
        ${
          c.email
            ? `<div class="contact-detail"><a href="mailto:${esc(
                c.email
              )}">${esc(c.email)}</a></div>`
            : ""
        }
        ${c.phone ? `<div class="contact-detail">${esc(c.phone)}</div>` : ""}
      </div>`;
          });
          html += "</div>";
        } else {
          html +=
            '<p class="text-muted text-sm mb">Inga kontakter hittades.</p>';
        }

        // Regulatory
        if (extracted.regulatoryDisclosure) {
          html +=
            '<h3 style="margin:20px 0 12px;">Regulatorisk information</h3>';
          html += `<div class="section-block" style="border-left-color:var(--yellow);"><p>${esc(
            extracted.regulatoryDisclosure
          )}</p></div>`;
        }

        // Certified Adviser
        if (extracted.certifiedAdviser) {
          html += '<h3 style="margin:20px 0 12px;">Certified Adviser</h3>';
          html += `<div class="section-block" style="border-left-color:var(--green);"><p>${esc(
            extracted.certifiedAdviser
          )}</p></div>`;
        }

        // About
        if (extracted.aboutCompany) {
          html += '<h3 style="margin:20px 0 12px;">Om bolaget</h3>';
          html += `<div class="section-block" style="border-left-color:var(--accent);"><p>${esc(
            extracted.aboutCompany
          )}</p></div>`;
        }

        // Sections
        if (extracted.sections.length) {
          html += '<h3 style="margin:20px 0 12px;">Sektioner</h3>';
          extracted.sections.forEach((s) => {
            html += `<div class="section-block"><h4>${esc(
              s.heading
            )}</h4><p>${esc(s.text)}</p></div>`;
          });
        }

        el.innerHTML = html;
      }

      // =============================================================================
      // TAB 4: MATCHES TABLE
      // =============================================================================
      function initMatches() {
        // Populate exchange filter
        const exchanges = new Set();
        MFN_MATCHES.forEach((m) => {
          (m.mfn_tickers || []).forEach((t) => {
            const ex = t.split(":")[0];
            if (ex !== "CAPA" && ex !== "XLON") exchanges.add(ex);
          });
        });
        const sel = document.getElementById("match-exchange");
        [...exchanges].sort().forEach((ex) => {
          sel.innerHTML += `<option value="${ex}">${ex}</option>`;
        });
        document.getElementById("match-count").textContent = MFN_MATCHES.length;
        filterMatches();
      }

      function filterMatches() {
        const q = document.getElementById("match-search").value.toLowerCase();
        const ex = document.getElementById("match-exchange").value;
        const src = document.getElementById("match-source").value;

        let filtered = MFN_MATCHES;
        if (q) {
          filtered = filtered.filter(
            (m) =>
              m.db_name.toLowerCase().includes(q) ||
              m.mfn_name.toLowerCase().includes(q) ||
              m.orgNumber.includes(q) ||
              m.mfn_slug.includes(q) ||
              (m.mfn_tickers || []).some((t) => t.toLowerCase().includes(q))
          );
        }
        if (ex) {
          filtered = filtered.filter((m) =>
            (m.mfn_tickers || []).some((t) => t.startsWith(ex + ":"))
          );
        }
        if (src) {
          filtered = filtered.filter((m) => m.sources.includes(src));
        }

        document.getElementById("match-count").textContent = filtered.length;
        const tbody = document.getElementById("matches-tbody");
        tbody.innerHTML = filtered
          .map((m) => {
            const tickers = (m.mfn_tickers || [])
              .filter((t) => !t.startsWith("CAPA:") && !t.startsWith("XLON:"))
              .map((t) => `<span class="badge badge-blue">${esc(t)}</span>`)
              .join(" ");
            const sources = m.sources
              .map(
                (s) =>
                  `<span class="badge ${
                    s === "FamilyOffice" ? "badge-purple" : "badge-muted"
                  }">${esc(s)}</span>`
              )
              .join(" ");
            return `<tr onclick="selectCompany('${escJs(m.mfn_slug)}', '${escJs(
              m.mfn_name
            )}')">
      <td><strong>${esc(m.db_name)}</strong></td>
      <td>${esc(m.mfn_name)}</td>
      <td class="mono text-sm">${esc(m.mfn_slug)}</td>
      <td>${tickers}</td>
      <td class="mono text-sm">${esc(m.orgNumber)}</td>
      <td><span class="badge ${getMatchTypeBadge(m.match_type)}">${esc(
              m.match_type
            )}${m.fuzzy_score ? ` (${m.fuzzy_score})` : ""}</span></td>
      <td>${sources}</td>
    </tr>`;
          })
          .join("");
      }

      // =============================================================================
      // TAB 5: TOOLS
      // =============================================================================
      async function fetchEntityCount() {
        const btn = document.getElementById("entity-count-btn");
        btn.disabled = true;
        btn.innerHTML =
          '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div> H\u00e4mtar...';
        const statsEl = document.getElementById("entity-stats");
        try {
          const res = await fetch(
            "https://mfn.se/search/companies?query=&limit=2000"
          );
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const entities = await res.json();

          // Compute stats
          const exchangeCounts = {};
          let withOrg = 0,
            withISIN = 0,
            withLogo = 0;
          entities.forEach((e) => {
            (e.tickers || []).forEach((t) => {
              const ex = t.split(":")[0];
              exchangeCounts[ex] = (exchangeCounts[ex] || 0) + 1;
            });
            if ((e.local_refs || []).some((r) => r.startsWith("SE:")))
              withOrg++;
            if ((e.isins || []).length) withISIN++;
            if (e.brand_image_url) withLogo++;
          });

          const topExchanges = Object.entries(exchangeCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 8);

          statsEl.style.display = "block";
          statsEl.innerHTML = `
      <div class="stat-grid mb">
        <div class="stat-card"><div class="stat-value">${
          entities.length
        }</div><div class="stat-label">Totalt entiteter</div></div>
        <div class="stat-card"><div class="stat-value">${withOrg}</div><div class="stat-label">Med orgnummer (SE:)</div></div>
        <div class="stat-card"><div class="stat-value">${withISIN}</div><div class="stat-label">Med ISIN</div></div>
        <div class="stat-card"><div class="stat-value">${withLogo}</div><div class="stat-label">Med logotyp</div></div>
      </div>
      <h3 style="margin-bottom:8px;">Tickers per b\u00f6rs</h3>
      <div class="stat-grid">
        ${topExchanges
          .map(
            ([ex, count]) =>
              `<div class="stat-card"><div class="stat-value" style="font-size:22px;">${count}</div><div class="stat-label">${esc(
                ex
              )}</div></div>`
          )
          .join("")}
      </div>`;
        } catch (err) {
          statsEl.style.display = "block";
          statsEl.innerHTML = `<div class="error-msg">${esc(
            err.message
          )}</div>`;
        } finally {
          btn.disabled = false;
          btn.textContent = "H\u00e4mta alla entiteter";
        }
      }

      function generateFeedUrls() {
        const slug = document.getElementById("feed-slug-input").value.trim();
        if (!slug) return;
        const el = document.getElementById("feed-urls");
        const urls = [
          {
            label: "JSON (f\u00f6retag)",
            url: `https://mfn.se/all/a/${slug}.json`,
          },
          { label: "RSS 2.0", url: `https://mfn.se/all/a/${slug}.rss` },
          { label: "Atom", url: `https://mfn.se/all/a/${slug}.atom` },
          { label: "XML", url: `https://mfn.se/all/a/${slug}.xml` },
          { label: "JSON (nordiskt)", url: `https://mfn.se/all/s/nordic.json` },
          { label: "RSS (nordiskt)", url: `https://mfn.se/all/s/nordic.rss` },
        ];
        el.innerHTML =
          '<div class="flex-col gap-sm mt">' +
          urls
            .map(
              (u) =>
                `<div class="url-output"><a href="${esc(
                  u.url
                )}" target="_blank">${esc(u.label)}: ${esc(
                  u.url
                )}</a><button class="btn btn-sm btn-secondary" onclick="navigator.clipboard.writeText('${esc(
                  u.url
                )}');this.textContent='Kopierad!';setTimeout(()=>this.textContent='Kopiera',1500)">Kopiera</button></div>`
            )
            .join("") +
          "</div>";
      }

      function buildStorageUrl() {
        const url = document.getElementById("storage-url-input").value.trim();
        if (!url) return;
        const size = document.getElementById("storage-size").value;
        const el = document.getElementById("storage-result");
        let finalUrl = url;
        if (size) {
          const sep = url.includes("?") ? "&" : "?";
          finalUrl = `${url}${sep}size=${size}`;
        }
        el.innerHTML = `
    <div class="url-output mt">
      <a href="${esc(finalUrl)}" target="_blank">${esc(finalUrl)}</a>
      <button class="btn btn-sm btn-secondary" onclick="navigator.clipboard.writeText('${esc(
        finalUrl
      )}');this.textContent='Kopierad!';setTimeout(()=>this.textContent='Kopiera',1500)">Kopiera</button>
    </div>
    <img class="image-preview" src="${esc(
      finalUrl
    )}" alt="Forhandsgranskning" onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
    <p class="text-sm text-muted mt-sm" style="display:none;">Kunde inte ladda bilden. Kontrollera att URL:en \u00e4r korrekt.</p>`;
      }

      function toggleWebSocket() {
        if (wsConnection) {
          wsConnection.close();
          wsConnection = null;
          updateWsUI("disconnected");
          return;
        }

        updateWsUI("connecting");
        const log = document.getElementById("ws-log");
        log.style.display = "block";
        log.innerHTML =
          '<div class="ws-item"><span class="ws-time">' +
          new Date().toLocaleTimeString("sv-SE") +
          "</span> Ansluter till wss://mfn.se/all/s/nordic...</div>";

        try {
          wsConnection = new WebSocket("wss://mfn.se/all/s/nordic");

          wsConnection.onopen = () => {
            updateWsUI("connected");
            addWsLog("Ansluten!", "var(--green)");
          };

          wsConnection.onmessage = (event) => {
            const data = event.data;
            // MFN sends HTML fragments â€” try to extract title
            const titleMatch =
              data.match(/<[^>]*class="[^"]*title[^"]*"[^>]*>([^<]+)/i) ||
              data.match(/<a[^>]*>([^<]{10,})</);
            const title = titleMatch
              ? titleMatch[1].trim()
              : "(nytt meddelande)";
            addWsLog(title, "var(--text)");
          };

          wsConnection.onclose = (event) => {
            updateWsUI("disconnected");
            addWsLog(
              `Fr\u00e5nkopplad (kod: ${event.code})`,
              "var(--text-muted)"
            );
            wsConnection = null;
            // Auto-reconnect on server-requested fast reconnect
            if (event.code === 3000) {
              addWsLog(
                "Server beg\u00e4rde snabb \u00e5teranslutning...",
                "var(--yellow)"
              );
              setTimeout(toggleWebSocket, 500);
            }
          };

          wsConnection.onerror = () => {
            addWsLog("Anslutningsfel", "var(--red)");
          };
        } catch (err) {
          updateWsUI("disconnected");
          addWsLog("Kunde inte ansluta: " + err.message, "var(--red)");
        }
      }

      function updateWsUI(state) {
        const dot = document.getElementById("ws-dot");
        const text = document.getElementById("ws-status-text");
        const btn = document.getElementById("ws-connect-btn");
        dot.className = "ws-dot";
        if (state === "connected") {
          dot.classList.add("connected");
          text.textContent = "Ansluten";
          btn.textContent = "Koppla fr\u00e5n";
        } else if (state === "connecting") {
          dot.classList.add("connecting");
          text.textContent = "Ansluter...";
          btn.disabled = true;
          setTimeout(() => (btn.disabled = false), 2000);
        } else {
          text.textContent = "Fr\u00e5nkopplad";
          btn.textContent = "Anslut";
        }
      }

      function addWsLog(msg, color) {
        const log = document.getElementById("ws-log");
        const time = new Date().toLocaleTimeString("sv-SE");
        const div = document.createElement("div");
        div.className = "ws-item";
        div.innerHTML = `<span class="ws-time">${time}</span> <span class="ws-title" style="color:${color}">${esc(
          msg
        )}</span>`;
        log.insertBefore(div, log.firstChild);
        // Cap at 100 entries
        while (log.children.length > 100) log.removeChild(log.lastChild);
      }

      // =============================================================================
      // INIT
      // =============================================================================
      initMatches();

      // Detect file:// protocol and show CORS warning
      if (window.location.protocol === "file:") {
        document.getElementById("cors-banner").style.display = "block";
      }
    </script>
  </body>
</html>
