<!doctype html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MFN Explorer â€” Nordiska pressmeddelanden</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect rx='20' width='100' height='100' fill='%234a6cf7'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white' font-family='sans-serif' font-weight='bold'>M</text></svg>"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --bg: #0f1117;
        --bg-card: #1a1d27;
        --bg-card-hover: #222632;
        --bg-input: #12141c;
        --border: #2a2e3a;
        --border-focus: #4a6cf7;
        --text: #e2e5ed;
        --text-muted: #8b90a0;
        --text-heading: #f0f2f7;
        --accent: #4a6cf7;
        --accent-hover: #5b7af8;
        --green: #34d399;
        --green-bg: rgba(52, 211, 153, 0.12);
        --red: #f87171;
        --red-bg: rgba(248, 113, 113, 0.12);
        --yellow: #fbbf24;
        --yellow-bg: rgba(251, 191, 36, 0.12);
        --purple: #a78bfa;
        --purple-bg: rgba(167, 139, 250, 0.12);
        --cyan: #22d3ee;
        --cyan-bg: rgba(34, 211, 238, 0.12);
        --radius: 8px;
        --radius-lg: 12px;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        --transition: 150ms ease;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.5;
        min-height: 100vh;
      }

      /* ---- LAYOUT ---- */
      .app-header {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        padding: 12px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .app-logo {
        font-size: 20px;
        font-weight: 700;
        color: var(--accent);
        white-space: nowrap;
      }
      .app-logo .subtitle {
        color: var(--text-muted);
        font-weight: 400;
        font-size: 14px;
        margin-left: 8px;
      }
      .app-logo .version {
        color: var(--text-muted);
        font-weight: 400;
        font-size: 11px;
        margin-left: 6px;
        opacity: 0.6;
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .cors-banner {
        background: var(--yellow-bg);
        border: 1px solid rgba(251, 191, 36, 0.3);
        color: var(--yellow);
        padding: 10px 24px;
        font-size: 13px;
        text-align: center;
        display: none;
      }

      /* ---- DASHBOARD GRID ---- */
      .dashboard {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 20px;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px 24px;
      }
      .dashboard-main {
        min-width: 0;
      }
      .dashboard-sidebar {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      @media (max-width: 1024px) {
        .dashboard {
          grid-template-columns: 1fr;
          padding: 16px;
        }
        .dashboard-sidebar {
          order: -1;
        }
      }
      @media (max-width: 640px) {
        .app-header {
          flex-wrap: wrap;
          padding: 12px 16px;
          gap: 8px;
        }
        .app-logo .subtitle {
          display: none;
        }
        .search-row {
          flex-direction: column;
        }
        .filter-bar {
          flex-direction: column;
          align-items: stretch;
        }
        .filter-bar select {
          width: 100% !important;
          min-width: unset !important;
        }
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }

      /* ---- COLLAPSIBLE PANEL ---- */
      .panel {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
      }
      .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        cursor: pointer;
        user-select: none;
        transition: background var(--transition);
      }
      .panel-header:hover {
        background: rgba(255, 255, 255, 0.03);
      }
      .panel-header h3 {
        margin: 0;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .panel-chevron {
        color: var(--text-muted);
        font-size: 12px;
        transition: transform 0.2s ease;
      }
      .panel.open .panel-chevron {
        transform: rotate(180deg);
      }
      .panel-body {
        display: none;
        padding: 0 16px 16px;
      }
      .panel.open .panel-body {
        display: block;
        animation: fadeIn 0.15s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-4px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }

      /* ---- SHARED COMPONENTS ---- */
      input[type="text"],
      input[type="url"],
      select {
        background: var(--bg-input);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 10px 14px;
        border-radius: var(--radius);
        font-size: 14px;
        width: 100%;
        transition: border-color var(--transition);
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: var(--border-focus);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 10px 18px;
        border-radius: var(--radius);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition);
        white-space: nowrap;
      }
      .btn:hover {
        background: var(--accent-hover);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn-secondary {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
      }
      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.12);
      }
      .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
      }

      .card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 20px;
        transition: all var(--transition);
      }
      .card:hover {
        border-color: rgba(74, 108, 247, 0.3);
      }
      .card-clickable {
        cursor: pointer;
      }
      .card-clickable:hover {
        background: var(--bg-card-hover);
      }

      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }
      .badge-blue {
        background: rgba(74, 108, 247, 0.15);
        color: var(--accent);
      }
      .badge-green {
        background: var(--green-bg);
        color: var(--green);
      }
      .badge-red {
        background: var(--red-bg);
        color: var(--red);
      }
      .badge-yellow {
        background: var(--yellow-bg);
        color: var(--yellow);
      }
      .badge-purple {
        background: var(--purple-bg);
        color: var(--purple);
      }
      .badge-cyan {
        background: var(--cyan-bg);
        color: var(--cyan);
      }
      .badge-muted {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text-muted);
      }

      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.15);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }
      .spinner-lg {
        width: 32px;
        height: 32px;
        border-width: 3px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-center {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 60px;
        gap: 12px;
        color: var(--text-muted);
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
      }
      .empty-state .icon {
        font-size: 40px;
        margin-bottom: 12px;
        opacity: 0.5;
      }
      .empty-state h3 {
        color: var(--text);
        margin-bottom: 8px;
      }

      .error-msg {
        background: var(--red-bg);
        border: 1px solid rgba(248, 113, 113, 0.3);
        color: var(--red);
        padding: 12px 16px;
        border-radius: var(--radius);
        font-size: 14px;
        margin-bottom: 16px;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 16px;
      }
      @media (max-width: 768px) {
        .grid-2,
        .grid-3 {
          grid-template-columns: 1fr;
        }
      }

      .flex-row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .flex-wrap {
        flex-wrap: wrap;
      }
      .flex-col {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .gap-sm {
        gap: 8px;
      }
      .gap-lg {
        gap: 20px;
      }
      .mt-sm {
        margin-top: 8px;
      }
      .mt {
        margin-top: 16px;
      }
      .mt-lg {
        margin-top: 24px;
      }
      .mb {
        margin-bottom: 16px;
      }

      h2 {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-heading);
        margin-bottom: 16px;
      }
      h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-heading);
      }
      .text-muted {
        color: var(--text-muted);
      }
      .text-sm {
        font-size: 13px;
      }
      .text-xs {
        font-size: 11px;
      }
      .mono {
        font-family: "JetBrains Mono", "SF Mono", "Fira Code", monospace;
      }

      .search-row {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
      }
      .search-row input {
        flex: 1;
      }

      .company-logo {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        object-fit: contain;
        background: #fff;
        flex-shrink: 0;
      }
      .company-logo-lg {
        width: 56px;
        height: 56px;
        border-radius: 8px;
      }

      .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }

      /* ---- NEWS ITEM ---- */
      .news-item {
        margin-bottom: 16px;
      }
      .news-item .news-header {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }
      .news-item .news-meta {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 6px;
      }
      .news-item .news-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-heading);
        margin-bottom: 4px;
        line-height: 1.35;
      }
      .news-item .news-company {
        font-size: 13px;
        color: var(--accent);
      }
      .news-item .news-date {
        font-size: 12px;
        color: var(--text-muted);
      }

      /* Preamble shown below header */
      .news-item .news-preamble {
        font-size: 14px;
        color: var(--text);
        line-height: 1.6;
        margin-top: 10px;
        font-style: italic;
        border-left: 3px solid var(--accent);
        padding-left: 12px;
      }

      /* Full body content */
      .news-item .news-body {
        margin-top: 12px;
        font-size: 13.5px;
        line-height: 1.65;
        color: var(--text-muted);
        overflow: hidden;
      }
      .news-item .news-body p {
        margin-bottom: 8px;
      }
      .news-item .news-body strong,
      .news-item .news-body b {
        color: var(--text);
      }
      .news-item .news-body a {
        color: var(--accent);
        text-decoration: none;
      }
      .news-item .news-body a:hover {
        text-decoration: underline;
      }
      .news-item .news-body table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin: 8px 0;
      }
      .news-item .news-body table td,
      .news-item .news-body table th {
        padding: 4px 8px;
        border: 1px solid var(--border);
        text-align: left;
      }
      .news-item .news-body table th {
        background: rgba(255, 255, 255, 0.04);
        color: var(--text);
      }
      .news-item .news-body img {
        max-width: 100%;
        border-radius: var(--radius);
        margin: 8px 0;
      }
      .news-item .news-body ul,
      .news-item .news-body ol {
        margin: 6px 0 6px 20px;
      }
      .news-item .news-body h1,
      .news-item .news-body h2,
      .news-item .news-body h3 {
        color: var(--text-heading);
        font-size: 14px;
        margin: 12px 0 4px;
      }

      /* Collapsible body */
      .news-item .news-body.collapsed {
        max-height: 300px;
        position: relative;
      }
      .news-item .news-body.collapsed::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 80px;
        background: linear-gradient(transparent, var(--bg-card));
        pointer-events: none;
      }
      .news-item .news-body.expanded {
        max-height: none;
      }
      .news-toggle {
        display: inline-block;
        margin-top: 8px;
        font-size: 13px;
        color: var(--accent);
        cursor: pointer;
        font-weight: 500;
      }
      .news-toggle:hover {
        text-decoration: underline;
      }

      /* Attachments row */
      .news-attachments {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
      }
      .att-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(255, 255, 255, 0.05);
        padding: 6px 12px;
        border-radius: var(--radius);
        color: var(--accent);
        text-decoration: none;
        font-size: 12px;
        transition: background var(--transition);
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .att-chip:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .att-chip .att-icon {
        flex-shrink: 0;
      }

      .news-regulatory {
        border-left: 3px solid var(--yellow);
      }

      /* MFN footer sections - hide in feed */
      .news-body .mfn-footer {
        display: none;
      }

      /* ---- FILTER BAR ---- */
      .filter-bar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 16px;
        align-items: center;
      }
      .filter-bar label {
        font-size: 13px;
        color: var(--text-muted);
        margin-right: 4px;
      }
      .filter-bar select {
        width: auto;
        min-width: 120px;
      }

      /* ---- CONTACT EXTRACTION ---- */
      .contact-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px;
      }
      .contact-card .contact-name {
        font-weight: 600;
        color: var(--text-heading);
        font-size: 15px;
      }
      .contact-card .contact-role {
        color: var(--purple);
        font-size: 13px;
        margin-top: 2px;
      }
      .contact-card .contact-detail {
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 4px;
      }
      .contact-card .contact-detail a {
        color: var(--accent);
        text-decoration: none;
      }
      .contact-card .contact-detail a:hover {
        text-decoration: underline;
      }

      .section-block {
        background: rgba(255, 255, 255, 0.02);
        border-left: 3px solid var(--border);
        padding: 12px 16px;
        border-radius: 0 var(--radius) var(--radius) 0;
        margin-bottom: 12px;
      }
      .section-block h4 {
        color: var(--text-heading);
        font-size: 14px;
        margin-bottom: 6px;
      }
      .section-block p {
        font-size: 13px;
        line-height: 1.6;
        color: var(--text-muted);
        white-space: pre-wrap;
      }

      /* ---- MATCHES TABLE ---- */
      .matches-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      .matches-table th {
        text-align: left;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.04);
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
      }
      .matches-table td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        vertical-align: middle;
      }
      .matches-table tr {
        transition: background var(--transition);
        cursor: pointer;
      }
      .matches-table tbody tr:hover {
        background: var(--bg-card-hover);
      }

      /* ---- TOOLS ---- */
      .tool-section {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 16px;
      }
      .tool-section h3 {
        margin-bottom: 12px;
      }

      .url-output {
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 10px 14px;
        font-family: monospace;
        font-size: 13px;
        word-break: break-all;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }
      .url-output a {
        color: var(--accent);
        text-decoration: none;
        flex: 1;
      }
      .url-output a:hover {
        text-decoration: underline;
      }

      .ws-log {
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 12px;
        max-height: 400px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
        line-height: 1.6;
      }
      .ws-log .ws-item {
        padding: 4px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      }
      .ws-log .ws-time {
        color: var(--text-muted);
      }
      .ws-log .ws-title {
        color: var(--text);
      }

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
      }
      .stat-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        text-align: center;
      }
      .stat-card .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--accent);
      }
      .stat-card .stat-label {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      .image-preview {
        max-width: 300px;
        max-height: 200px;
        border-radius: var(--radius);
        margin-top: 12px;
        border: 1px solid var(--border);
      }

      .ws-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
      }
      .ws-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-muted);
      }
      .ws-dot.connected {
        background: var(--green);
      }
      .ws-dot.connecting {
        background: var(--yellow);
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }

      /* ---- FEED SEARCH ---- */
      .feed-search-row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }
      .feed-search-row input {
        flex: 1;
        padding: 8px 12px;
        font-size: 13px;
      }
      .feed-count {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 8px;
      }

      /* ---- LIVE INDICATOR ---- */
      .live-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        font-size: 11px;
        font-weight: 600;
        color: var(--green);
        background: var(--green-bg);
        padding: 3px 8px;
        border-radius: 10px;
        margin-left: 8px;
      }
      .live-badge .live-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--green);
        animation: pulse 2s infinite;
      }

      /* ---- TAB BADGE ---- */
      .tab-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 18px;
        height: 18px;
        background: var(--green);
        color: #000;
        font-size: 10px;
        font-weight: 700;
        border-radius: 9px;
        padding: 0 5px;
        margin-left: 4px;
      }

      /* ---- NEW ITEM FLASH ---- */
      @keyframes newsFlash {
        0% {
          background: rgba(52, 211, 153, 0.15);
        }
        100% {
          background: var(--bg-card);
        }
      }
      .news-item-new {
        animation: newsFlash 2s ease-out;
      }

      /* ---- LOAD MORE ---- */
      .load-more-bar {
        text-align: center;
        padding: 16px;
      }
      .load-more-bar .btn {
        min-width: 200px;
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="app-logo">
        MFN Explorer <span class="subtitle">Nordiska pressmeddelanden</span
        ><span class="version">v2.0</span>
      </div>
      <div class="header-right">
        <span id="live-indicator" style="display: none"
          ><span class="live-badge"
            ><span class="live-dot"></span>LIVE</span
          ></span
        >
        <div class="ws-status">
          <span class="ws-dot" id="ws-dot"></span>
          <span id="ws-status-text">Fr&aring;nkopplad</span>
        </div>
      </div>
    </header>
    <div class="cors-banner" id="cors-banner">
      OBS: Denna app h&auml;mtar data fr&aring;n mfn.se via CORS-proxy.
      &Ouml;ppna via webbserver f&ouml;r b&auml;st resultat.
    </div>

    <div class="dashboard">
      <!-- ========== MAIN: NEWS FEED ========== -->
      <div class="dashboard-main">
        <div
          class="flex-row mb"
          style="justify-content: space-between; flex-wrap: wrap"
        >
          <h2 id="feed-title" style="margin-bottom: 0">Nyhetsfl&ouml;de</h2>
          <div class="flex-row gap-sm">
            <button
              class="btn btn-sm"
              onclick="loadWatchedFeed()"
              id="btn-watched"
              style="background: var(--green); color: #000; font-weight: 600"
            >
              &#9733; Bevakade
            </button>
            <button class="btn btn-secondary btn-sm" onclick="loadNordicFeed()">
              Nordiskt
            </button>
            <button
              class="btn btn-secondary btn-sm"
              id="load-more-btn"
              onclick="loadMoreNews()"
              style="display: none"
            >
              Ladda fler
            </button>
          </div>
        </div>
        <div class="filter-bar">
          <select
            id="filter-lang"
            onchange="applyFilters()"
            style="min-width: 100px"
          >
            <option value="">Alla spr&aring;k</option>
            <option value="sv">Svenska</option>
            <option value="en">English</option>
          </select>
          <select
            id="filter-type"
            onchange="applyFilters()"
            style="min-width: 140px"
          >
            <option value="">Alla typer</option>
            <option value="ir">Regulatorisk (IR)</option>
            <option value="pr">Pressmeddelande (PR)</option>
          </select>
          <input
            type="text"
            id="feed-search"
            placeholder="S&ouml;k bland nyheter..."
            oninput="applyFilters()"
            style="
              flex: 1;
              min-width: 120px;
              padding: 8px 12px;
              font-size: 13px;
            "
          />
        </div>
        <div id="feed-count" class="feed-count"></div>
        <div id="feed-results"></div>
      </div>

      <!-- ========== SIDEBAR ========== -->
      <div class="dashboard-sidebar">
        <!-- S&ouml;k bolag -->
        <div class="panel open" id="panel-search">
          <div class="panel-header" onclick="togglePanel('panel-search')">
            <h3>&#128269; S&ouml;k bolag p&aring; MFN</h3>
            <span class="panel-chevron">&#9660;</span>
          </div>
          <div class="panel-body">
            <div class="search-row" style="margin-bottom: 8px">
              <input
                type="text"
                id="company-search"
                placeholder="Bolagsnamn, ticker, ISIN..."
              />
              <button class="btn btn-sm" onclick="doCompanySearch()">
                S&ouml;k
              </button>
            </div>
            <div id="search-results"></div>
          </div>
        </div>

        <!-- Matchade bolag -->
        <div class="panel" id="panel-matches">
          <div class="panel-header" onclick="togglePanel('panel-matches')">
            <h3>
              &#127919; Bevakade bolag
              <span class="badge badge-blue" id="match-count">62</span>
            </h3>
            <span class="panel-chevron">&#9660;</span>
          </div>
          <div class="panel-body">
            <div class="search-row" style="margin-bottom: 8px">
              <input
                type="text"
                id="match-search"
                placeholder="Filtrera p&aring; namn, ticker..."
                oninput="filterMatches()"
              />
              <select
                id="match-exchange"
                onchange="filterMatches()"
                style="width: auto; min-width: 100px"
              >
                <option value="">Alla b&ouml;rser</option>
              </select>
              <select
                id="match-source"
                onchange="filterMatches()"
                style="width: auto; min-width: 100px"
              >
                <option value="">Alla k&auml;llor</option>
                <option value="WatchedCompany">WatchedCompany</option>
                <option value="FamilyOffice">FamilyOffice</option>
              </select>
            </div>
            <div style="overflow-x: auto; max-height: 400px; overflow-y: auto">
              <table class="matches-table">
                <thead>
                  <tr>
                    <th>Bolag</th>
                    <th>Ticker</th>
                    <th>Matchtyp</th>
                  </tr>
                </thead>
                <tbody id="matches-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Kontaktextraktion -->
        <div class="panel" id="panel-extract">
          <div class="panel-header" onclick="togglePanel('panel-extract')">
            <h3>&#128100; Kontaktextraktion</h3>
            <span class="panel-chevron">&#9660;</span>
          </div>
          <div class="panel-body">
            <div id="extract-empty">
              <p class="text-sm text-muted">
                Klicka p&aring; en nyhet och expandera den f&ouml;r att
                extrahera kontakter.
              </p>
            </div>
            <div id="extract-content" style="display: none"></div>
          </div>
        </div>

        <!-- Feed-l&auml;nkar -->
        <div class="panel" id="panel-feeds">
          <div class="panel-header" onclick="togglePanel('panel-feeds')">
            <h3>&#128279; RSS / JSON-fl&ouml;den</h3>
            <span class="panel-chevron">&#9660;</span>
          </div>
          <div class="panel-body">
            <div class="search-row" style="margin-bottom: 8px">
              <input
                type="text"
                id="feed-slug-input"
                placeholder="Slug (t.ex. climeon)"
              />
              <button class="btn btn-sm" onclick="generateFeedUrls()">
                Generera
              </button>
            </div>
            <div id="feed-urls"></div>
          </div>
        </div>

        <!-- Entiteter -->
        <div class="panel" id="panel-entities">
          <div class="panel-header" onclick="togglePanel('panel-entities')">
            <h3>&#128202; MFN-entiteter</h3>
            <span class="panel-chevron">&#9660;</span>
          </div>
          <div class="panel-body">
            <button
              class="btn btn-sm"
              id="entity-count-btn"
              onclick="fetchEntityCount()"
            >
              H&auml;mta statistik
            </button>
            <div id="entity-stats" class="mt" style="display: none"></div>
          </div>
        </div>

        <!-- Bildverktyg -->
        <div class="panel" id="panel-storage">
          <div class="panel-header" onclick="togglePanel('panel-storage')">
            <h3>&#128248; Bildverktyg</h3>
            <span class="panel-chevron">&#9660;</span>
          </div>
          <div class="panel-body">
            <div class="search-row" style="margin-bottom: 8px">
              <input
                type="url"
                id="storage-url-input"
                placeholder="storage.mfn.se URL..."
              />
              <select id="storage-size" style="width: auto; min-width: 80px">
                <option value="">Org</option>
                <option value="w-512" selected>512</option>
                <option value="w-1024">1024</option>
              </select>
              <button class="btn btn-sm" onclick="buildStorageUrl()">
                Bygg
              </button>
            </div>
            <div id="storage-result"></div>
          </div>
        </div>

        <!-- WebSocket-logg -->
        <div class="panel" id="panel-websocket">
          <div class="panel-header" onclick="togglePanel('panel-websocket')">
            <h3>&#9889; WebSocket-logg</h3>
            <span class="panel-chevron">&#9660;</span>
          </div>
          <div class="panel-body">
            <div class="flex-row gap-sm mb">
              <button
                class="btn btn-sm"
                id="ws-connect-btn"
                onclick="toggleWebSocket()"
              >
                Koppla fr&aring;n
              </button>
            </div>
            <div
              class="ws-log"
              id="ws-log"
              style="display: none; max-height: 250px"
            ></div>
          </div>
        </div>
      </div>
      <!-- /sidebar -->
    </div>
    <!-- /dashboard -->

    <script>
      // =============================================================================
      // EMBEDDED MATCH DATA (62 companies)
      // =============================================================================
      const MFN_MATCHES = [
        {
          db_name: "Agtira AB",
          orgNumber: "559033-7654",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Agtira",
          mfn_entity_id: "6772b210-accd-45b6-83a3-b5880548554c",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "agtira",
          mfn_tickers: ["FNSE:AGTIRA B"],
          mfn_isins: ["SE0008588354"],
        },
        {
          db_name: "Arjo AB (publ)",
          orgNumber: "559092-8064",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Arjo",
          mfn_entity_id: "b1688b29-8069-42cd-a151-26f3c25fb314",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "arjo",
          mfn_tickers: ["XSTO:ARJO B", "XLON:0HQ8"],
          mfn_isins: ["SE0010468116"],
        },
        {
          db_name: "Avsalt AB",
          orgNumber: "559199-3661",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Avsalt Group",
          mfn_entity_id: "f5dee7bb-b8b5-41dd-a9fb-73fafd4fbd3a",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "avsalt-group",
          mfn_tickers: ["NSME:AVSALT"],
          mfn_isins: ["SE0022242681"],
        },
        {
          db_name: "Bioextrax AB (publ)",
          orgNumber: "556965-1473",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Bioextrax",
          mfn_entity_id: "6c5dcc45-aa20-4e1a-9a7c-fcd7579ecf03",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "bioextrax",
          mfn_tickers: ["FNSE:BIOEX", "CAPA:BIOEXs"],
          mfn_isins: ["SE0016276752"],
        },
        {
          db_name: "Biofrigas Sweden AB (publ)",
          orgNumber: "556902-2881",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Biofrigas",
          mfn_entity_id: "15abfbb4-3d68-4fe1-9660-cb7d5eb534de",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "biofrigas",
          mfn_tickers: ["XSAT:BIOF"],
          mfn_isins: ["SE0014262887"],
        },
        {
          db_name: "BoMill AB",
          orgNumber: "556556-4332",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "BoMill",
          mfn_entity_id: "03059498-fd6e-44c9-8819-7159558f9686",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "bomill",
          mfn_tickers: ["FNSE:BOMILL", "CAPA:BOMILs"],
          mfn_isins: ["SE0014583332"],
        },
        {
          db_name: "Bure Equity",
          orgNumber: "556454-8781",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "normalized",
          mfn_name: "Bure Equity AB",
          mfn_entity_id: "448ddd85-ea99-42a7-9f3d-6b124dad8218",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "bure-equity",
          mfn_tickers: ["XSTO:BURE", "CAPA:BUREs", "XLON:0N7D"],
          mfn_isins: ["SE0000195810"],
        },
        {
          db_name: "Byggmastare AJ Ahlstrom",
          orgNumber: "556943-7774",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "fuzzy",
          mfn_name: "Byggmastare Anders J Ahlstrom Holding",
          mfn_entity_id: "e2dfa7e6-0903-440c-b01a-c5a0ebf5cbc2",
          mfn_ticker: null,
          mfn_exchange: null,
          fuzzy_score: 0.885,
          mfn_slug: "byggmastare-anders-j-ahlstrom-holding",
          mfn_tickers: ["XSTO:AJA B", "CAPA:AJABs"],
          mfn_isins: ["SE0026876476"],
        },
        {
          db_name: "Byhmgard AB",
          orgNumber: "559335-3773",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Byhmgard",
          mfn_entity_id: "ee4bae61-2150-40ec-9d1a-575f6bffdd17",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "byhmgard",
          mfn_tickers: ["NSME:BESS"],
          mfn_isins: ["SE0023849583"],
        },
        {
          db_name: "C100 AB (publ)",
          orgNumber: "559074-4313",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "C100",
          mfn_entity_id: "1591f5be-ee47-465e-8837-9e0b147b5c5a",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "c100",
          mfn_tickers: ["XSAT:C100"],
          mfn_isins: ["SE0017616006"],
        },
        {
          db_name: "Cinis Fertilizer AB",
          orgNumber: "559154-0322",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Cinis Fertilizer",
          mfn_entity_id: "f742d533-f091-4e65-a37f-a7df33b25ad8",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "cinis-fertilizer",
          mfn_tickers: ["FNSE:CINIS", "CAPA:CINISs"],
          mfn_isins: ["SE0018040784"],
        },
        {
          db_name: "CirChem AB",
          orgNumber: "556951-7427",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "CirChem",
          mfn_entity_id: "e58aeb30-e62f-437f-a617-d48be513c389",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "circhem",
          mfn_tickers: ["FNSE:CIRCHE", "CAPA:CIRCHs"],
          mfn_isins: ["SE0015193529"],
        },
        {
          db_name: "Clean Motion AB",
          orgNumber: "556788-1825",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Clean Motion",
          mfn_entity_id: "ccccca99-07c3-49a8-bc7e-3a79381052f0",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "clean-motion",
          mfn_tickers: ["FNSE:CLEMO", "CAPA:CLEMOs"],
          mfn_isins: ["SE0008216303"],
        },
        {
          db_name: "Climeon AB (publ)",
          orgNumber: "556846-1643",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Climeon",
          mfn_entity_id: "e0b40489-12e2-4051-83d9-92e177479aa8",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "climeon",
          mfn_tickers: ["FNSE:CLIME B", "XLON:0GHX"],
          mfn_isins: ["SE0023837182"],
        },
        {
          db_name: "Creades",
          orgNumber: "556866-0723",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "exact",
          mfn_name: "Creades",
          mfn_entity_id: "fb2167f5-154e-4c8f-8faf-f97e05f7e260",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "creades",
          mfn_tickers: ["XSTO:CRED A", "CAPA:CREDAs", "XLON:0QI9"],
          mfn_isins: ["SE0015661236"],
        },
        {
          db_name: "Creturner Group AB (publ)",
          orgNumber: "559152-3013",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Creturner",
          mfn_entity_id: "da54afa6-3e68-435a-a5ae-49b4146e7c9a",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "creturner",
          mfn_tickers: ["NSME:CRET"],
          mfn_isins: ["SE0013460375"],
        },
        {
          db_name: "CTEK AB (publ)",
          orgNumber: "559217-4659",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "CTEK",
          mfn_entity_id: "e62f1df4-2a77-44a2-a737-2e37b7f54580",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "ctek",
          mfn_tickers: ["XSTO:CTEK", "CAPA:CTEKs"],
          mfn_isins: ["SE0016798763"],
        },
        {
          db_name: "CTEK Sweden AB",
          orgNumber: "556540-3234",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "CTEK",
          mfn_entity_id: "e62f1df4-2a77-44a2-a737-2e37b7f54580",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "ctek",
          mfn_tickers: ["XSTO:CTEK", "CAPA:CTEKs"],
          mfn_isins: ["SE0016798763"],
        },
        {
          db_name: "DUG Foodtech AB (publ)",
          orgNumber: "559054-4655",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "DUG Foodtech",
          mfn_entity_id: "9c345ccd-ead8-470f-b4b4-79c86e9a3d34",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "dug-foodtech",
          mfn_tickers: ["FNSE:DUG"],
          mfn_isins: ["SE0013281979"],
        },
        {
          db_name: "Duni AB",
          orgNumber: "556536-7488",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Duni",
          mfn_entity_id: "81ca67a1-632b-450f-9db7-946963f337d1",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "duni",
          mfn_tickers: ["XSTO:DUNI", "CAPA:DUNIs", "XLON:0HR3"],
          mfn_isins: ["SE0000616716"],
        },
        {
          db_name: "Ecoclime Group AB",
          orgNumber: "556902-1800",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Ecoclime Group",
          mfn_entity_id: "84e87bbd-13a1-49c8-85fb-60305f6f7fb8",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "ecoclime-group",
          mfn_tickers: ["NSME:ECC B"],
          mfn_isins: ["SE0012729937"],
        },
        {
          db_name: "EcoRub AB",
          orgNumber: "556438-0284",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "EcoRub",
          mfn_entity_id: "f95f3646-db5e-487c-9f2c-28f8ec9ee3bd",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "ecorub",
          mfn_tickers: ["XSAT:ECO B"],
          mfn_isins: ["SE0003273531"],
        },
        {
          db_name: "Ferroamp AB (publ)",
          orgNumber: "556805-7029",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Ferroamp",
          mfn_entity_id: "181e39e6-9efd-4a51-ace1-6f8a53ab8084",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "ferroamp",
          mfn_tickers: ["FNSE:FERRO", "CAPA:FERROs"],
          mfn_isins: ["SE0012229920"],
        },
        {
          db_name: "Flat Capital",
          orgNumber: "556941-0110",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "normalized",
          mfn_name: "Flat Capital AB (publ)",
          mfn_entity_id: "d2547a69-6c9f-4362-84c5-5f865f10f5e8",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "flatcapital",
          mfn_tickers: ["FNSE:FLAT B", "CAPA:FLATBs"],
          mfn_isins: ["SE0016609846"],
        },
        {
          db_name: "Gomero Group AB",
          orgNumber: "556623-4976",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Gomero Group",
          mfn_entity_id: "f04b73a1-751d-4053-abd7-23c00568e60d",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "gomero-group",
          mfn_tickers: ["XSAT:GOMERO"],
          mfn_isins: ["SE0011167535"],
        },
        {
          db_name: "Greater Than AB",
          orgNumber: "556965-2885",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Greater Than",
          mfn_entity_id: "8a32dd94-37d7-4ddd-b0c8-0ab52b893dfb",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "greater-than",
          mfn_tickers: ["FNSE:GREAT", "CAPA:GREATs"],
          mfn_isins: ["SE0005881554"],
        },
        {
          db_name: "HEXICON AB",
          orgNumber: "556795-9894",
          sources: ["WatchedCompany"],
          match_type: "exact",
          mfn_name: "Hexicon AB",
          mfn_entity_id: "7457764f-216d-47f5-b393-b1445169e0de",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "hexicon",
          mfn_tickers: ["FNSE:HEXI", "CAPA:HEXIs"],
          mfn_isins: ["SE0004898799"],
        },
        {
          db_name: "Humble Group AB",
          orgNumber: "556794-4797",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Humble Group",
          mfn_entity_id: "030869fd-b776-4c2d-864f-ef7749563b24",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "humble-group",
          mfn_tickers: ["XSTO:HUMBLE", "CAPA:HUMBLs"],
          mfn_isins: ["SE0006261046"],
        },
        {
          db_name: "Hybricon AB",
          orgNumber: "556936-2196",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Hybricon",
          mfn_entity_id: "67ff99dc-15b2-450b-8fb5-e7e9028a8b29",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "hybricon",
          mfn_tickers: ["NSME:HYCO"],
          mfn_isins: ["SE0015345897"],
        },
        {
          db_name: "I-Tech AB",
          orgNumber: "556585-9682",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "I-tech",
          mfn_entity_id: "eb7cf689-1860-4422-ab01-ed858f5a3051",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "i-tech",
          mfn_tickers: ["FNSE:ITECH", "CAPA:ITECHs"],
          mfn_isins: ["SE0011167725"],
        },
        {
          db_name: "Insplorion AB",
          orgNumber: "556798-8760",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Insplorion",
          mfn_entity_id: "4dd45bfb-1fed-4439-95ff-80d6ce84fa1f",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "insplorion",
          mfn_tickers: ["FNSE:INSP", "CAPA:INSPs"],
          mfn_isins: ["SE0006994943"],
        },
        {
          db_name: "Latour",
          orgNumber: "556026-3237",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "exact",
          mfn_name: "Latour",
          mfn_entity_id: "7cbfe9cb-a109-486e-a3f1-c33ce8cdb5ed",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "latour",
          mfn_tickers: ["XSTO:LATO B", "CAPA:LATOBs", "XLON:0RQP"],
          mfn_isins: ["SE0010100958"],
        },
        {
          db_name: "Linc",
          orgNumber: "559210-8947",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "normalized",
          mfn_name: "Linc AB",
          mfn_entity_id: "6fb3250d-226b-46fa-8ac8-6d756ffe293c",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "linc-ab",
          mfn_tickers: ["XSTO:LINC", "CAPA:LINCs"],
          mfn_isins: ["SE0015949433"],
        },
        {
          db_name: "LN Future Invest AB",
          orgNumber: "556419-2663",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "LN Future Invest",
          mfn_entity_id: "82630657-54ca-45e4-b226-ff7a10fe63b9",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "ln-future-invest",
          mfn_tickers: ["FNSE:LNFI", "CAPA:LNFIs"],
          mfn_isins: ["SE0014730347"],
        },
        {
          db_name: "Lyckegard Group AB",
          orgNumber: "556757-7597",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Lyckegard Group",
          mfn_entity_id: "8daf41d8-6193-444c-a885-876b7e365c07",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "lyckegard",
          mfn_tickers: ["FNSE:LYGRD"],
          mfn_isins: ["SE0017160575"],
        },
        {
          db_name: "Lyko Group",
          orgNumber: "556975-8229",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "normalized",
          mfn_name: "Lyko Group AB",
          mfn_entity_id: "d9e11522-2f7d-4fd1-8f4b-9eac25d021ce",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "lyko-group",
          mfn_tickers: ["FNSE:LYKO A", "CAPA:LYKOAs"],
          mfn_isins: ["SE0010468918"],
        },
        {
          db_name: "Mantex Aktiebolag",
          orgNumber: "556550-8537",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Mantex",
          mfn_entity_id: "94e8c5f0-4ec9-4639-beaa-dab4616cd47d",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "mantex",
          mfn_tickers: ["FNSE:MANTEX", "CAPA:MANTEs"],
          mfn_isins: ["SE0023467451"],
        },
        {
          db_name: "Metacon AB (publ)",
          orgNumber: "556724-1616",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Metacon",
          mfn_entity_id: "b2233b77-be55-4257-8aea-ebab70d8a63a",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "metacon",
          mfn_tickers: ["FNSE:META", "CAPA:METAs"],
          mfn_isins: ["SE0003086214"],
        },
        {
          db_name: "Midsummer AB",
          orgNumber: "556665-7838",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Midsummer",
          mfn_entity_id: "df4fc81a-de11-49a3-b0b0-cedeca36ec82",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "midsummer",
          mfn_tickers: ["FNSE:MIDS", "CAPA:MIDSs"],
          mfn_isins: ["SE0011281757"],
        },
        {
          db_name: "Minesto AB",
          orgNumber: "556719-4914",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Minesto",
          mfn_entity_id: "bef24d45-e9b1-4798-b8f1-76c4c4cccde8",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "minesto",
          mfn_tickers: ["FNSE:MINEST", "CAPA:MINESs"],
          mfn_isins: ["SE0007578141"],
        },
        {
          db_name: "Modelon AB (publ)",
          orgNumber: "556672-3010",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Modelon AB",
          mfn_entity_id: "07c7a020-b9be-4e5a-96cb-398cb39918ce",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "modelon",
          mfn_tickers: ["FNSE:MODEL", "CAPA:MODELs"],
          mfn_isins: ["SE0023112438"],
        },
        {
          db_name: "Monivent AB",
          orgNumber: "556956-5707",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Monivent",
          mfn_entity_id: "2143d2da-a46f-49ba-a3e9-43d1863c6435",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "monivent",
          mfn_tickers: ["XSAT:MONI"],
          mfn_isins: ["SE0013512282"],
        },
        {
          db_name: "Nattaro Labs AB",
          orgNumber: "556846-8465",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Nattaro Labs",
          mfn_entity_id: "0f238a1e-5696-483c-98b7-d8ffbfd8ae66",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "nattaro-labs",
          mfn_tickers: ["XSAT:NATTA"],
          mfn_isins: ["SE0016844534"],
        },
        {
          db_name: "Nexam Chemical AB",
          orgNumber: "556784-6711",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Nexam Chemical Holding",
          mfn_entity_id: "dab4bce0-29cd-462c-9772-afdb47b39268",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "nexam-chemical-holding",
          mfn_tickers: ["FNSE:NEXAM", "CAPA:NEXAMs"],
          mfn_isins: ["SE0005101003"],
        },
        {
          db_name: "Oresund",
          orgNumber: "556539-8582",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "exact",
          mfn_name: "Oresund",
          mfn_entity_id: "11a3dda7-3314-4d20-8f12-3d421dc35519",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "oresund",
          mfn_tickers: ["XSTO:ORES", "CAPA:ORESs", "XLON:0RGB"],
          mfn_isins: ["SE0008321608"],
        },
        {
          db_name: "OrganoClick AB",
          orgNumber: "556704-6908",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "OrganoClick",
          mfn_entity_id: "912d1f41-c37e-4c46-b044-e0a07c59d4a4",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "organoclick",
          mfn_tickers: ["FNSE:ORGC", "CAPA:ORGCs"],
          mfn_isins: ["SE0006510335"],
        },
        {
          db_name: "Powercell Sweden AB (publ)",
          orgNumber: "556759-8353",
          sources: ["WatchedCompany"],
          match_type: "exact",
          mfn_name: "PowerCell Sweden AB (publ)",
          mfn_entity_id: "05cf9591-3152-4479-bf8d-e60a78178e2e",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "powercell-sweden",
          mfn_tickers: ["XSTO:PCELL", "CAPA:PCELLs", "XLON:0G9R"],
          mfn_isins: ["SE0006425815"],
        },
        {
          db_name: "Prebona AB",
          orgNumber: "556855-5022",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Prebona",
          mfn_entity_id: "eeb34480-ef27-49dc-abc1-df29cf8c2f67",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "prebona",
          mfn_tickers: ["XSAT:PREBON"],
          mfn_isins: ["SE0007692884"],
        },
        {
          db_name: "Recyctec AB",
          orgNumber: "556750-7628",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Recyctec Holding",
          mfn_entity_id: "20633de6-7753-430e-9b03-1c1b2eaeb2b2",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "recyctec-holding",
          mfn_tickers: ["XSAT:RECY B"],
          mfn_isins: ["SE0014808978"],
        },
        {
          db_name: "SaltX Technology Holding AB (publ)",
          orgNumber: "556917-6596",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "SaltX Technology Holding",
          mfn_entity_id: "f2771f71-b2c1-41bd-9c53-7705d0cf3d20",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "saltx-technology-holding",
          mfn_tickers: ["FNSE:SALT B", "CAPA:SALTBs", "XLON:0G6W"],
          mfn_isins: ["SE0005308541"],
        },
        {
          db_name: "Scandinavian Enviro Systems AB",
          orgNumber: "556605-6726",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Scandinavian Enviro Systems AB (publ)",
          mfn_entity_id: "43f3e6a4-3cf4-4770-83dc-816845770e1f",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "scandinavian-enviro-systems",
          mfn_tickers: ["FNSE:SES", "CAPA:SESs"],
          mfn_isins: ["SE0005877560"],
        },
        {
          db_name: "SeaTwirl AB (publ)",
          orgNumber: "556890-1135",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "SeaTwirl",
          mfn_entity_id: "96f5751a-ae16-441d-a892-2f7f526934a6",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "seatwirl",
          mfn_tickers: ["FNSE:STW", "CAPA:STWs"],
          mfn_isins: ["SE0009242175"],
        },
        {
          db_name: "SHT Smart High-Tech Aktiebolag",
          orgNumber: "556077-7434",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "SHT Smart High-Tech",
          mfn_entity_id: "1f35ee24-967c-4138-9ee6-6df83b33df79",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "sht-smart-high-tech",
          mfn_tickers: ["XSAT:SHT B"],
          mfn_isins: ["SE0016843809"],
        },
        {
          db_name: "Smoltek Nanotech Holding AB",
          orgNumber: "559020-2262",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Smoltek Nanotech Holding",
          mfn_entity_id: "bb4ad7ad-d359-4389-b113-99f64ff84603",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "smoltek-nanotech-holding",
          mfn_tickers: ["XSAT:SMOL", "CAPA:SMOLs"],
          mfn_isins: ["SE0010820381"],
        },
        {
          db_name: "Sustainable Energy Solutions Sweden Holding AB",
          orgNumber: "556530-5868",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Sustainable Energy Solutions Sweden Holding",
          mfn_entity_id: "8f2c9e97-1050-4382-9387-b0f511ae5dd6",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "sustainable-energy-solutions-sweden-holding",
          mfn_tickers: ["NSME:SENS"],
          mfn_isins: ["SE0011643980"],
        },
        {
          db_name: "Svenska Aerogel AB",
          orgNumber: "556581-3028",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Svenska Aerogel Holding",
          mfn_entity_id: "dc018f91-f062-4fb3-b093-4798a7b3c568",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "svenska-aerogel-holding",
          mfn_tickers: ["FNSE:AERO", "CAPA:AEROs"],
          mfn_isins: ["SE0023440557"],
        },
        {
          db_name: "Svolder",
          orgNumber: "556469-2019",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "normalized",
          mfn_name: "Svolder AB (publ)",
          mfn_entity_id: "0591da51-7678-40da-a783-47ddb63a6698",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "svolder",
          mfn_tickers: [
            "XSTO:SVOL B",
            "CAPA:SVOLBs",
            "XSTO:SVOL A",
            "CAPA:SVOLAs",
          ],
          mfn_isins: ["SE0017161441", "SE0017161458"],
        },
        {
          db_name: "Traction",
          orgNumber: "556105-1243",
          sources: ["WatchedCompany", "FamilyOffice"],
          match_type: "exact",
          mfn_name: "Traction",
          mfn_entity_id: "551fe57a-5d99-4cb2-98eb-d97a4c860afe",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "traction",
          mfn_tickers: ["XSTO:TRAC B", "CAPA:TRACBs", "XLON:0GOS"],
          mfn_isins: ["SE0000391716"],
        },
        {
          db_name: "Unibap Space Solutions AB (publ)",
          orgNumber: "556925-1134",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Unibap Space Solutions",
          mfn_entity_id: "8a253944-3750-45ab-a596-0cddc602c70c",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "unibap-space-solutions",
          mfn_tickers: ["FNSE:UNIBAP", "CAPA:UNIBAs"],
          mfn_isins: ["SE0009606809"],
        },
        {
          db_name: "Vend Marketplaces AB",
          orgNumber: "556610-3429",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Vend Marketplaces",
          mfn_entity_id: "70ba2154-90b6-447b-bd70-e7464c6c82d3",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "vend-marketplaces",
          mfn_tickers: ["XOSL:VEND", "XLON:0R9I"],
          mfn_isins: ["NO0010736879"],
        },
        {
          db_name: "Voi Technology AB",
          orgNumber: "559160-2999",
          sources: ["WatchedCompany"],
          match_type: "exact",
          mfn_name: "Voi Technology AB",
          mfn_entity_id: "84595893-0285-46d9-af1f-9ba2199a718a",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "voitechnology",
          mfn_tickers: [],
          mfn_isins: ["SE0023134952"],
        },
        {
          db_name: "Xoma AB",
          orgNumber: "559071-5750",
          sources: ["WatchedCompany"],
          match_type: "normalized",
          mfn_name: "Xoma",
          mfn_entity_id: "2ab3447a-2103-4385-bfd8-35acacd93748",
          mfn_ticker: null,
          mfn_exchange: null,
          mfn_slug: "xoma",
          mfn_tickers: ["XSAT:XOMA B"],
          mfn_isins: ["SE0019174194"],
        },
      ];

      // =============================================================================
      // STATE
      // =============================================================================
      let currentFeedSlug = null;
      let currentFeedItems = [];
      let allFeedItems = [];
      let currentOffset = 0;
      let expandedNewsId = null;
      let selectedNewsForExtraction = null;
      let wsConnection = null;
      let liveNewItems = 0; // count of new items from WebSocket since last view
      const CACHE_KEY = "mfn-explorer-feed-cache";
      const CACHE_TTL = 5 * 60 * 1000; // 5 min

      // =============================================================================
      // PANEL TOGGLE
      // =============================================================================
      function togglePanel(id) {
        document.getElementById(id).classList.toggle("open");
      }

      // No-op switchToTab for backwards compat with selectCompany
      function switchToTab() {}

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && expandedNewsId) {
          const el = document.getElementById("news-expand-" + expandedNewsId);
          if (el) el.style.display = "none";
          expandedNewsId = null;
        }
        if (e.key === "Enter" && e.target.id === "company-search") {
          doCompanySearch();
        }
      });

      function updateFeedBadge() {
        // no-op in dashboard mode
      }

      // =============================================================================
      // CACHE HELPERS
      // =============================================================================
      function saveFeedCache(items) {
        try {
          const data = { items: items.slice(0, 50), ts: Date.now() };
          localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        } catch (e) {
          /* quota exceeded, ignore */
        }
      }

      function loadFeedCache() {
        try {
          const raw = localStorage.getItem(CACHE_KEY);
          if (!raw) return null;
          const data = JSON.parse(raw);
          if (Date.now() - data.ts > CACHE_TTL) return null;
          return data.items;
        } catch (e) {
          return null;
        }
      }

      // =============================================================================
      // HELPERS
      // =============================================================================
      function esc(s) {
        if (!s) return "";
        const d = document.createElement("div");
        d.textContent = s;
        return d.innerHTML;
      }

      /** Escape for use inside single-quoted JS string in onclick attributes */
      function escJs(s) {
        if (!s) return "";
        return s
          .replace(/\\/g, "\\\\")
          .replace(/'/g, "\\'")
          .replace(/&/g, "&amp;");
      }

      function formatDate(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        return d.toLocaleDateString("sv-SE", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatRelativeDate(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        const now = new Date();
        const diffMs = now - d;
        const diffMin = Math.floor(diffMs / 60000);
        const diffH = Math.floor(diffMs / 3600000);
        const diffD = Math.floor(diffMs / 86400000);
        if (diffMin < 1) return "Just nu";
        if (diffMin < 60) return diffMin + " min sedan";
        if (diffH < 24) return diffH + " tim sedan";
        if (diffD < 7)
          return diffD + " dag" + (diffD > 1 ? "ar" : "") + " sedan";
        return d.toLocaleDateString("sv-SE", {
          month: "short",
          day: "numeric",
          year: diffD > 365 ? "numeric" : undefined,
        });
      }

      const TAG_LABELS = {
        ":regulatory": "Regulatorisk",
        ":regulatory:mar": "MAR",
        ":regulatory:listing": "Notering",
        "sub:report": "Rapport",
        "sub:report:annual": "\u00c5rsredovisning",
        "sub:report:interim": "Delrapport",
        "sub:report:interim:q1": "Q1",
        "sub:report:interim:q2": "Q2",
        "sub:report:interim:q3": "Q3",
        "sub:report:interim:q4": "Q4",
        "sub:ca": "Bolagsh\u00e4ndelse",
        "sub:ca:ma": "F\u00f6rv\u00e4rv",
        "sub:ca:other": "Annan h\u00e4ndelse",
        "sub:ci": "Bolagsinfo",
        "sub:ci:insider": "Insynshandel",
        "sub:ci:gm:notice": "St\u00e4mmokallelse",
        "sub:ci:staff": "Personalf\u00f6r\u00e4ndring",
        "sub:ci:other": "Annan info",
        "ext:nq": "Nasdaq",
        "ext:nq:corporate-action": "Corporate Action",
        "ext:nq:company-announcement": "Meddelande",
        "cus:equity-research": "Aktieanalys",
      };

      function showLoading(el) {
        el.innerHTML =
          '<div class="loading-center"><div class="spinner spinner-lg"></div><span>Laddar...</span></div>';
      }

      function showError(el, msg) {
        el.innerHTML = `<div class="error-msg">${esc(msg)}</div>`;
      }

      function showEmpty(el, icon, title, desc) {
        el.innerHTML = `<div class="empty-state"><div class="icon">${icon}</div><h3>${esc(
          title,
        )}</h3><p>${esc(desc)}</p></div>`;
      }

      function getTagBadgeClass(tag) {
        if (tag === ":regulatory" || tag === "sub:ca") return "badge-yellow";
        if (tag.startsWith("sub:report") || tag === "sub:annual-report")
          return "badge-purple";
        if (tag.startsWith("sub:")) return "badge-cyan";
        if (tag === ":central") return "badge-green";
        return "badge-muted";
      }

      function getMatchTypeBadge(type) {
        if (type === "exact") return "badge-green";
        if (type === "normalized") return "badge-blue";
        if (type === "fuzzy") return "badge-yellow";
        return "badge-muted";
      }

      function getExchange(ticker) {
        if (!ticker) return null;
        const prefix = ticker.split(":")[0];
        const map = {
          XSTO: "Nasdaq Stockholm",
          FNSE: "First North",
          XSAT: "Spotlight",
          NSME: "Nordic SME",
          XOSL: "Oslo Bors",
          XLON: "London",
          CAPA: "Capa",
        };
        return map[prefix] || prefix;
      }

      // =============================================================================
      // CORS PROXY â€” MFN.se does not send CORS headers
      // =============================================================================
      const CORS_PROXIES = [
        (url) =>
          `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
      ];
      let activeProxyIndex = 0;
      let useProxy = true;

      async function mfnFetch(url) {
        // Try direct first (works from localhost / same-origin)
        if (!useProxy) {
          try {
            const direct = await fetch(url, {
              signal: AbortSignal.timeout(5000),
            });
            const text = await direct.text();
            try {
              JSON.parse(text);
            } catch {
              throw new Error("Not JSON");
            }
            return new Response(text, {
              status: 200,
              headers: { "content-type": "application/json" },
            });
          } catch (e) {
            useProxy = true;
          }
        }

        // Try proxies (allorigins first â€” verified working)
        for (let i = 0; i < CORS_PROXIES.length; i++) {
          const idx = (activeProxyIndex + i) % CORS_PROXIES.length;
          try {
            const proxied = await fetch(CORS_PROXIES[idx](url), {
              signal: AbortSignal.timeout(15000),
            });
            if (proxied.ok) {
              activeProxyIndex = idx;
              return proxied;
            }
          } catch (e) {
            continue;
          }
        }
        throw new Error(
          "Kunde inte n\u00e5 MFN.se \u2014 f\u00f6rs\u00f6k igen om en stund",
        );
      }

      // =============================================================================
      // TAB 1: COMPANY SEARCH
      // =============================================================================
      const searchInput = document.getElementById("company-search");
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") doCompanySearch();
      });

      let searchDebounce = null;
      searchInput.addEventListener("input", () => {
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => {
          if (searchInput.value.trim().length >= 2) doCompanySearch();
        }, 400);
      });

      async function doCompanySearch() {
        const q = searchInput.value.trim();
        if (!q) return;
        const el = document.getElementById("search-results");
        showLoading(el);
        try {
          const res = await mfnFetch(
            `https://mfn.se/search/companies?limit=10&query=${encodeURIComponent(
              q,
            )}`,
          );
          const companies = await res.json();
          if (!companies.length) {
            showEmpty(
              el,
              "&#128269;",
              "Inga resultat",
              `Hittade inga bolag f\u00f6r "${q}".`,
            );
            return;
          }
          el.innerHTML =
            '<div class="flex-col gap-sm">' +
            companies
              .map((c) => {
                const logo = c.brand_image_url
                  ? `<img class="company-logo" src="${esc(
                      c.brand_image_url,
                    )}?size=w-512" alt="" onerror="this.style.display='none'">`
                  : "";
                const tickers = (c.tickers || [])
                  .filter((t) => !t.startsWith("CAPA:"))
                  .map((t) => `<span class="badge badge-blue">${esc(t)}</span>`)
                  .join(" ");
                const isins = (c.isins || [])
                  .map(
                    (i) =>
                      `<span class="badge badge-muted mono">${esc(i)}</span>`,
                  )
                  .join(" ");
                const orgs = (c.local_refs || [])
                  .filter((r) => r.startsWith("SE:"))
                  .map(
                    (r) =>
                      `<span class="badge badge-purple mono">${esc(
                        r.replace("SE:", ""),
                      )}</span>`,
                  )
                  .join(" ");
                return `
        <div class="card card-clickable" onclick="selectCompany('${escJs(
          c.slug,
        )}', '${escJs(c.name)}')">
          <div class="flex-row" style="gap:16px;">
            ${logo}
            <div style="flex:1;min-width:0;">
              <div style="font-weight:600;font-size:16px;color:var(--text-heading);">${esc(
                c.name,
              )}</div>
              <div class="text-sm text-muted" style="margin-top:2px;">Slug: <span class="mono">${esc(
                c.slug,
              )}</span></div>
              <div class="tag-list mt-sm">${tickers} ${isins} ${orgs}</div>
            </div>
          </div>
        </div>`;
              })
              .join("") +
            "</div>";
        } catch (err) {
          showError(el, "Kunde inte s\u00f6ka: " + err.message);
        }
      }

      function selectCompany(slug, name) {
        currentFeedSlug = slug;
        document.getElementById("feed-title").textContent = `Nyheter: ${name}`;
        loadCompanyNews(slug);
        // Scroll feed into view
        document
          .getElementById("feed-results")
          .scrollIntoView({ behavior: "smooth", block: "start" });
      }

      // =============================================================================
      // TAB 2: NEWS FEED
      // =============================================================================
      async function loadCompanyNews(slug) {
        const el = document.getElementById("feed-results");
        showLoading(el);
        currentOffset = 0;
        try {
          const res = await mfnFetch(
            `https://mfn.se/all/a/${slug}.json?limit=20&compact=true`,
          );
          const data = await res.json();
          allFeedItems = data.items || [];
          currentFeedItems = allFeedItems;
          currentOffset = allFeedItems.length;
          document.getElementById("load-more-btn").style.display =
            allFeedItems.length >= 20 ? "" : "none";
          applyFilters();
        } catch (err) {
          showError(el, "Kunde inte ladda nyheter: " + err.message);
        }
      }

      // Build a Set of watched entity_ids for fast filtering
      const watchedEntityIds = new Set(MFN_MATCHES.map((m) => m.mfn_entity_id));
      const watchedSlugs = new Set(MFN_MATCHES.map((m) => m.mfn_slug));
      let watchedFeedMode = false;
      let watchedOffset = 0;

      async function loadWatchedFeed() {
        watchedFeedMode = true;
        currentFeedSlug = null;
        document.getElementById("feed-title").textContent =
          "\u2605 Bevakade bolag (" + MFN_MATCHES.length + " st)";
        const el = document.getElementById("feed-results");

        // Show cached data instantly while fetching fresh
        const cached = loadFeedCache();
        if (cached && cached.length > 0) {
          allFeedItems = cached;
          applyFilters();
        } else {
          showLoading(el);
        }

        allFeedItems = [];
        currentOffset = 0;
        watchedOffset = 0;
        try {
          await fetchWatchedBatch(el, 30);
        } catch (err) {
          if (!cached || cached.length === 0) {
            showError(
              el,
              "Kunde inte ladda bevakat fl\u00f6de: " + err.message,
            );
          }
        }
      }

      async function fetchWatchedBatch(el, targetCount) {
        let attempts = 0;
        while (allFeedItems.length < targetCount && attempts < 8) {
          const res = await mfnFetch(
            `https://mfn.se/all/s/nordic.json?limit=100&compact=true&offset=${watchedOffset}`,
          );
          const data = await res.json();
          const items = data.items || [];
          if (items.length === 0) break;
          watchedOffset += items.length;
          const matched = items.filter(
            (item) =>
              watchedEntityIds.has(item.author?.entity_id) ||
              watchedSlugs.has(item.author?.slug),
          );
          allFeedItems = allFeedItems.concat(matched);
          attempts++;
        }
        currentFeedItems = allFeedItems;
        currentOffset = watchedOffset;
        document.getElementById("load-more-btn").style.display = "";
        applyFilters();
      }

      async function loadNordicFeed() {
        watchedFeedMode = false;
        currentFeedSlug = null;
        document.getElementById("feed-title").textContent =
          "Nordiskt nyhetsfl\u00f6de";
        const el = document.getElementById("feed-results");
        showLoading(el);
        currentOffset = 0;
        try {
          const res = await mfnFetch(
            "https://mfn.se/all/s/nordic.json?limit=20&compact=true",
          );
          const data = await res.json();
          allFeedItems = data.items || [];
          currentFeedItems = allFeedItems;
          currentOffset = allFeedItems.length;
          document.getElementById("load-more-btn").style.display =
            allFeedItems.length >= 20 ? "" : "none";
          applyFilters();
        } catch (err) {
          showError(el, "Kunde inte ladda nordiskt fl\u00f6de: " + err.message);
        }
      }

      async function loadMoreNews() {
        if (watchedFeedMode) {
          const el = document.getElementById("feed-results");
          const prevCount = allFeedItems.length;
          try {
            await fetchWatchedBatch(el, allFeedItems.length + 20);
            if (allFeedItems.length === prevCount)
              document.getElementById("load-more-btn").style.display = "none";
          } catch (err) {
            console.error("Load more error:", err);
          }
          return;
        }
        const slug = currentFeedSlug;
        const url = slug
          ? `https://mfn.se/all/a/${slug}.json?limit=20&compact=true&offset=${currentOffset}`
          : `https://mfn.se/all/s/nordic.json?limit=20&compact=true&offset=${currentOffset}`;
        try {
          const res = await mfnFetch(url);
          const data = await res.json();
          const newItems = data.items || [];
          allFeedItems = allFeedItems.concat(newItems);
          currentOffset += newItems.length;
          if (newItems.length < 20)
            document.getElementById("load-more-btn").style.display = "none";
          applyFilters();
        } catch (err) {
          console.error("Load more error:", err);
        }
      }

      function applyFilters() {
        const lang = document.getElementById("filter-lang").value;
        const type = document.getElementById("filter-type").value;
        const search = (document.getElementById("feed-search").value || "")
          .toLowerCase()
          .trim();
        let items = allFeedItems;
        if (lang) items = items.filter((i) => i.properties?.lang === lang);
        if (type) items = items.filter((i) => i.properties?.type === type);

        // Free-text search across title, preamble, company name
        if (search) {
          items = items.filter((i) => {
            const title = (i.content?.title || i.title || "").toLowerCase();
            const preamble = (i.content?.preamble || "").toLowerCase();
            const company = (i.author?.name || "").toLowerCase();
            return (
              title.includes(search) ||
              preamble.includes(search) ||
              company.includes(search)
            );
          });
        }

        // Deduplicate sv/en pairs â€” prefer Swedish version
        // group_id is NOT shared between language versions, so we key on
        // entity_id + publish_date which IS identical for sv/en pairs
        if (!lang) {
          const groups = new Map();
          for (const item of items) {
            const eid = item.author?.entity_id || "";
            const pub = item.content?.publish_date || item.published || "";
            const key = eid && pub ? `${eid}::${pub}` : item.news_id;
            const existing = groups.get(key);
            if (!existing) {
              groups.set(key, item);
            } else {
              if (
                item.properties?.lang === "sv" &&
                existing.properties?.lang !== "sv"
              ) {
                groups.set(key, item);
              }
            }
          }
          items = Array.from(groups.values());
        }

        // Update count display
        const countEl = document.getElementById("feed-count");
        if (search || lang || type) {
          countEl.textContent = `Visar ${items.length} av ${allFeedItems.length} nyheter`;
        } else {
          countEl.textContent = items.length ? `${items.length} nyheter` : "";
        }

        currentFeedItems = items;
        renderNewsFeed(items);

        // Cache the feed
        saveFeedCache(allFeedItems);
      }

      function renderNewsFeed(items) {
        const el = document.getElementById("feed-results");
        if (!items.length) {
          showEmpty(
            el,
            "&#128240;",
            "Inga nyheter",
            "Inga nyheter att visa med valda filter.",
          );
          return;
        }
        el.innerHTML = items
          .map((item, idx) => {
            const props = item.properties || {};
            const tags = (props.tags || [])
              .map(
                (t) =>
                  `<span class="badge ${getTagBadgeClass(t)}">${esc(
                    TAG_LABELS[t] || t.replace(/^[:]/, ""),
                  )}</span>`,
              )
              .join(" ");
            const isReg = (props.tags || []).includes(":regulatory");
            const lang = props.lang || "";
            const author = item.author || {};
            const logoHtml = author.brand_image_url
              ? `<img class="company-logo" src="${esc(
                  author.brand_image_url,
                )}?size=w-512" alt="" onerror="this.style.display='none'">`
              : "";
            const title = item.content?.title || item.title || "";
            const pubDate = item.content?.publish_date || item.published || "";
            const preamble = item.content?.preamble || "";
            const hasFulltext = !!(item.content?.html || item.content?.text);
            const isExpanded = expandedNewsId === item.news_id;

            // Preamble (always shown as preview)
            let preambleHtml = "";
            if (preamble) {
              preambleHtml = `<div class="news-preamble">${esc(preamble)}</div>`;
            }

            // Expand container (fulltext loaded on demand)
            const expandId = `news-expand-${item.news_id}`;
            let expandContent = "";
            if (isExpanded && hasFulltext) {
              expandContent = renderFulltextContent(item);
            }

            return `
      <div class="card news-item ${isReg ? "news-regulatory" : ""}" style="margin-bottom:12px;">
        <div class="news-header" style="cursor:pointer;" onclick="toggleNewsBody('${item.news_id}', ${idx})">
          ${logoHtml}
          <div style="flex:1;min-width:0;">
            <div class="news-title">${esc(title)}</div>
            <div class="news-meta">
              <span class="news-company">${esc(author.name || "")}</span>
              <span class="news-date">${formatRelativeDate(pubDate)}</span>
              <span class="badge ${lang === "sv" ? "badge-blue" : "badge-green"}">${esc(lang.toUpperCase())}</span>
              ${isReg ? '<span class="badge badge-yellow">REGULATORISK</span>' : ""}
              ${tags}
            </div>
          </div>
        </div>
        ${preambleHtml}
        <div id="${expandId}" style="display:${isExpanded ? "block" : "none"};">${expandContent}</div>
        <button class="news-toggle" id="news-toggle-${item.news_id}" onclick="event.stopPropagation(); toggleNewsBody('${item.news_id}', ${idx})">Visa mer \u25BC</button>
      </div>`;
          })
          .join("");
      }

      function renderFulltextContent(item) {
        const content = item.content || {};
        let html = "";

        // Body HTML
        if (content.html) {
          html += `<div class="news-body">${content.html}</div>`;
        } else if (content.text) {
          html += `<div class="news-body" style="white-space:pre-wrap;">${esc(content.text)}</div>`;
        }

        // Attachments
        const attachments = content.attachments || [];
        if (attachments.length) {
          const chips = attachments
            .map((a) => {
              const url = a.url || "";
              const fname =
                a.file_title || a.title || url.split("/").pop() || "Bilaga";
              const ext = url.split(".").pop().toLowerCase();
              let icon = "\uD83D\uDCCE";
              if (ext === "pdf") icon = "\uD83D\uDCC4";
              else if (
                ["png", "jpg", "jpeg", "gif", "svg", "webp"].includes(ext)
              )
                icon = "\uD83D\uDDBC\uFE0F";
              else if (["xls", "xlsx", "csv"].includes(ext))
                icon = "\uD83D\uDCCA";
              const ct = a.content_type || "";
              const sizeTag = ct
                ? `<span style="opacity:0.5;font-size:0.7rem;margin-left:4px;">${ct.split("/").pop()}</span>`
                : "";
              return `<a class="att-chip" href="${esc(url)}" target="_blank" rel="noopener" onclick="event.stopPropagation()"><span class="att-icon">${icon}</span>${esc(fname)}${sizeTag}</a>`;
            })
            .join("");
          html += `<div class="news-attachments">${chips}</div>`;
        }

        // Extract button
        if (content.html) {
          html += `<div style="margin-top:8px;"><button class="btn btn-sm btn-secondary" style="font-size:0.75rem;" onclick="event.stopPropagation(); selectedNewsForExtraction = currentFeedItems.find(i=>i.news_id==='${item.news_id}'); extractFromCurrent()">Extrahera kontakter</button></div>`;
        }

        return html;
      }

      async function toggleNewsBody(newsId, idx) {
        const expandEl = document.getElementById("news-expand-" + newsId);
        const toggle = document.getElementById("news-toggle-" + newsId);
        if (!expandEl) return;

        // If already expanded, collapse
        if (expandedNewsId === newsId) {
          expandEl.style.display = "none";
          if (toggle) {
            toggle.textContent = "Visa mer \u25BC";
            toggle.style.display = "";
          }
          expandedNewsId = null;
          return;
        }

        expandedNewsId = newsId;
        const item = currentFeedItems[idx];

        // If no fulltext yet, fetch it on demand
        if (item && (!item.content || !item.content.html)) {
          expandEl.innerHTML =
            '<div style="padding:16px;text-align:center;"><div class="spinner"></div><span style="margin-left:8px;color:var(--text-muted);font-size:0.85rem;">Laddar inneh\u00e5ll...</span></div>';
          expandEl.style.display = "block";
          if (toggle) toggle.style.display = "none";
          try {
            // Fetch fulltext via company feed (without compact)
            const slug = item.author?.slug;
            if (slug) {
              const res = await mfnFetch(
                `https://mfn.se/all/a/${slug}.json?limit=10`,
              );
              const data = await res.json();
              const found = (data.items || []).find(
                (i) => i.news_id === newsId,
              );
              if (found && found.content) {
                item.content = { ...item.content, ...found.content };
              }
            }
          } catch (e) {
            console.warn("Failed to fetch fulltext:", e);
          }
        }

        // Render fulltext
        expandEl.innerHTML = renderFulltextContent(item);
        expandEl.style.display = "block";
        if (toggle) {
          toggle.textContent = "Visa mindre \u25B2";
          toggle.style.display = "";
        }

        // Store for extraction
        selectedNewsForExtraction = item;
      }

      function extractFromCurrent() {
        if (!selectedNewsForExtraction) return;
        // Open extract panel in sidebar
        const panel = document.getElementById("panel-extract");
        if (!panel.classList.contains("open")) panel.classList.add("open");
        runExtraction(selectedNewsForExtraction);
        // Scroll sidebar panel into view
        panel.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }

      // =============================================================================
      // TAB 3: CONTACT EXTRACTION
      // =============================================================================
      function extractMfnContent(html) {
        const stripHtml = (s) =>
          s
            .replace(/<[^>]+>/g, "\n")
            .replace(/&amp;/g, "&")
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&quot;/g, '"')
            .replace(/&#039;/g, "'")
            .replace(/&nbsp;/g, " ")
            .replace(/\n{3,}/g, "\n\n")
            .trim();

        const contacts = [];

        // Strategy 1: mfn-footer mfn-contacts
        const contactFooter = html.match(
          /<div class="mfn-footer mfn-contacts[^"]*">([\s\S]*?)<\/div>\s*(?:\n<div|$)/,
        );
        // Strategy 2: generic mfn-footer with hash + contact keywords
        const contactGenericFooter = html.match(
          /<div class="mfn-footer mfn-[a-f0-9]+">[^]*?(?:CONTACT|kontakta|INFORMATION)[^]*?<\/div>/i,
        );
        // Strategy 3: bare mfn-footer
        const contactBareFooter = html.match(
          /<div class="mfn-footer">\s*(?:<p>)?\s*(?:<span>)*\s*(?:<span>)*\s*(?:<strong>)?\s*(?:Mediakontakt|Foretagskontakt|Investor Relations|Pressansvarig|Press\s*contact|Media\s*contact|CONTACT|kontakta|INFORMATION)[\s\S]*?<\/div>/i,
        );
        // Strategy 4: inline
        const contactInline = html.match(
          /<strong[^>]*>(?:<[^>]+>)*[^<]*(?:kontakt[a-z]*|(?:please )?contact)[^]*?<\/strong>(?:<\/p>)?\s*([\s\S]*?)(?:<div class="mfn-footer|<strong[^>]*class="mfn-heading|$)/i,
        );

        const contactSource =
          contactFooter?.[1] ??
          contactGenericFooter?.[0] ??
          contactBareFooter?.[0] ??
          contactInline?.[1] ??
          "";
        const contactBlock = stripHtml(contactSource);

        if (contactBlock) {
          const lines = contactBlock
            .split("\n")
            .map((l) => l.trim())
            .filter(
              (l) =>
                l &&
                l !== "-".repeat(l.length) &&
                l !== "_".repeat(l.length) &&
                !/^(?:FOR MORE|For (?:mer|ytterligare|vidare)|KONTAKT|Contact)/i.test(
                  l,
                ),
            );

          const emailRe = /^(?:E-?mail:\s*)?[\w.+-]+@[\w.-]+\.\w+$/i;
          const phoneRe = /^(?:Phone:\s*|Tel(?:efon)?:\s*)?[+0][\s()\d-]{7,}/i;
          const isEmail = (s) => emailRe.test(s);
          const isPhone = (s) => phoneRe.test(s);
          const extractEmailFn = (s) => {
            const m = s.match(/([\w.+-]+@[\w.-]+\.\w+)/);
            return m ? m[1] : s;
          };
          const extractPhoneFn = (s) =>
            s.replace(/^(?:Phone|Tel(?:efon)?):\s*/i, "").trim();

          const consumed = new Set();
          for (let i = 0; i < lines.length; i++) {
            if (consumed.has(i)) continue;

            // Pattern A
            const nameTitle =
              lines[i].length <= 200
                ? lines[i].match(/^([A-ZÃ…Ã„Ã–Ã‰ÃˆÃŠ][\wÃ©Ã¨ÃªÃ¥Ã¤Ã¶\s.-]{1,50}),\s*(.+?)$/)
                : null;
            if (nameTitle) {
              const name = nameTitle[1].trim();
              let role = nameTitle[2].trim();
              let email = null,
                phone = null;
              const inlineEmail = role.match(/([\w.+-]+@[\w.-]+\.\w+)/);
              const inlinePhone = role.match(/([+0][\s()\d-]{7,})/);
              if (inlineEmail) {
                email = inlineEmail[1];
                role = role
                  .replace(inlineEmail[0], "")
                  .replace(/,\s*$/, "")
                  .trim();
              }
              if (inlinePhone) {
                phone = inlinePhone[1].trim();
                role = role
                  .replace(inlinePhone[0], "")
                  .replace(/,\s*$/, "")
                  .trim();
              }
              consumed.add(i);
              for (let j = i + 1; j < Math.min(i + 6, lines.length); j++) {
                if (!email && isEmail(lines[j])) {
                  email = extractEmailFn(lines[j]);
                  consumed.add(j);
                } else if (!phone && isPhone(lines[j])) {
                  phone = extractPhoneFn(lines[j]);
                  consumed.add(j);
                } else if (/^(?:E-?mail|Phone|Tel):\s*$/i.test(lines[j]))
                  continue;
                else if (
                  lines[j].match(/^[A-ZÃ…Ã„Ã–]/) &&
                  !isEmail(lines[j]) &&
                  !isPhone(lines[j])
                )
                  break;
              }
              contacts.push({ name, role: role || null, email, phone });
              continue;
            }

            // Pattern B
            if (
              /^(?:Mediakontakt|Foretagskontakt|Investor Relations|Pressansvarig|Press\s*contact|Media\s*contact|Communications?\s*Department)/i.test(
                lines[i],
              )
            ) {
              const dept = lines[i];
              let name = null,
                role = null,
                email = null,
                phone = null;
              consumed.add(i);
              for (let j = i + 1; j < Math.min(i + 6, lines.length); j++) {
                if (isEmail(lines[j])) {
                  email = extractEmailFn(lines[j]);
                  consumed.add(j);
                } else if (isPhone(lines[j])) {
                  phone = extractPhoneFn(lines[j]);
                  consumed.add(j);
                } else if (
                  !name &&
                  /^[A-ZÃ…Ã„Ã–]/.test(lines[j]) &&
                  !isEmail(lines[j]) &&
                  !isPhone(lines[j])
                ) {
                  name = lines[j];
                  consumed.add(j);
                } else if (
                  name &&
                  !role &&
                  !isEmail(lines[j]) &&
                  !isPhone(lines[j]) &&
                  /^(?:CEO|CFO|CTO|COO|VD|VP|Head|Chief|Director|Chef|Kommunikation|Finans)/i.test(
                    lines[j],
                  )
                ) {
                  role = lines[j];
                  consumed.add(j);
                } else if (
                  /^(?:Mediakontakt|Foretagskontakt|Investor|Press)/i.test(
                    lines[j],
                  )
                )
                  break;
              }
              if (name || email)
                contacts.push({
                  name: name || dept,
                  role: role || dept,
                  email,
                  phone,
                });
              continue;
            }

            // Pattern C
            if (
              /^[A-ZÃ…Ã„Ã–Ã‰ÃˆÃŠ][\wÃ©Ã¨ÃªÃ¥Ã¤Ã¶\s.-]+$/.test(lines[i]) &&
              !isEmail(lines[i]) &&
              !isPhone(lines[i]) &&
              i + 1 < lines.length
            ) {
              const nextLine = lines[i + 1];
              const looksLikeRole =
                /(?:VD|CEO|CFO|CTO|COO|VP|Head|Chief|Director|Chef|direktÃ¶r|ansvarig|ordfÃ¶rande|Chairman|Manager|Officer|Investor|Communications|IR\b)/i.test(
                  nextLine,
                ) &&
                !isEmail(nextLine) &&
                !isPhone(nextLine);
              if (looksLikeRole) {
                const name = lines[i].trim();
                const role = nextLine.trim();
                let email = null,
                  phone = null;
                consumed.add(i);
                consumed.add(i + 1);
                for (let j = i + 2; j < Math.min(i + 5, lines.length); j++) {
                  if (!email && isEmail(lines[j])) {
                    email = extractEmailFn(lines[j]);
                    consumed.add(j);
                  } else if (!phone && isPhone(lines[j])) {
                    phone = extractPhoneFn(lines[j]);
                    consumed.add(j);
                  } else if (
                    /^[A-ZÃ…Ã„Ã–]/.test(lines[j]) &&
                    !isEmail(lines[j]) &&
                    !isPhone(lines[j])
                  )
                    break;
                }
                contacts.push({ name, role, email, phone });
                continue;
              }
            }

            // Pattern D
            if (
              /^[A-ZÃ…Ã„Ã–Ã‰ÃˆÃŠ]/.test(lines[i]) &&
              !isEmail(lines[i]) &&
              !isPhone(lines[i]) &&
              i + 1 < lines.length &&
              isEmail(lines[i + 1])
            ) {
              const name = lines[i].trim();
              const email = extractEmailFn(lines[i + 1]);
              let phone = null;
              consumed.add(i);
              consumed.add(i + 1);
              if (i + 2 < lines.length && isPhone(lines[i + 2])) {
                phone = extractPhoneFn(lines[i + 2]);
                consumed.add(i + 2);
              }
              contacts.push({ name, role: null, email, phone });
              continue;
            }
          }
        }

        // About Company
        const aboutMatch =
          html.match(
            /<div class="mfn-footer mfn-about[^"]*">([\s\S]*?)<\/div>/,
          ) ||
          html.match(
            /<div class="mfn-footer mfn-[a-f0-9]+">\s*(?:<p>)?\s*(?:<strong[^>]*>)?\s*(?:Om |About )[^]*?<\/div>/i,
          );
        const aboutCompany = aboutMatch
          ? stripHtml(aboutMatch[1] || aboutMatch[0])
          : null;

        // Regulatory
        const regMatch = html.match(
          /<div class="mfn-footer mfn-regulatory[^"]*">([\s\S]*?)<\/div>/,
        );
        const regulatoryDisclosure = regMatch ? stripHtml(regMatch[1]) : null;

        // Certified Adviser
        const text = stripHtml(html);
        const caMatch = text.match(
          /Certified Adviser[:\s]*\n(.*?)(?=\n\n|Om |About |$)/is,
        );
        const certifiedAdviser = caMatch ? caMatch[1].trim() : null;

        // Sections
        const sections = [];
        const headingParts = html.split(/<strong class="mfn-heading-[12]">/);
        for (let i = 1; i < headingParts.length; i++) {
          const endTag = headingParts[i].indexOf("</strong>");
          if (endTag === -1) continue;
          const heading = headingParts[i].substring(0, endTag).trim();
          const rest = headingParts[i].substring(endTag);
          const sectionEnd = rest.search(
            /<strong class="mfn-heading|<div class="mfn-footer/,
          );
          const sectionHtml =
            sectionEnd > 0 ? rest.substring(0, sectionEnd) : rest;
          const sectionText = stripHtml(sectionHtml).replace(/^\s*\n/, "");
          if (sectionText) sections.push({ heading, text: sectionText });
        }

        return {
          contacts,
          aboutCompany,
          certifiedAdviser,
          regulatoryDisclosure,
          sections,
        };
      }

      function runExtraction(item) {
        document.getElementById("extract-empty").style.display = "none";
        const el = document.getElementById("extract-content");
        el.style.display = "block";

        const content = item.content || {};
        if (!content.html) {
          el.innerHTML = `
      <div class="card mb">
        <h3>${esc(item.title)}</h3>
        <p class="text-sm text-muted mt-sm">${esc(
          item.author?.name || "",
        )} â€” ${formatDate(item.published)}</p>
      </div>
      <div class="error-msg">Denna nyhet saknar HTML-inneh\u00e5ll. Kontaktextraktion kr\u00e4ver fullst\u00e4ndig HTML.</div>`;
          return;
        }

        const extracted = extractMfnContent(content.html);

        let html = `
    <div class="card mb">
      <h3>${esc(item.title)}</h3>
      <p class="text-sm text-muted mt-sm">${esc(
        item.author?.name || "",
      )} â€” ${formatDate(item.published)}</p>
    </div>`;

        // Contacts
        html += '<h3 style="margin:20px 0 12px;">Kontakter</h3>';
        if (extracted.contacts.length) {
          html += '<div class="grid-2 mb">';
          extracted.contacts.forEach((c) => {
            html += `<div class="contact-card">
        <div class="contact-name">${esc(c.name)}</div>
        ${c.role ? `<div class="contact-role">${esc(c.role)}</div>` : ""}
        ${
          c.email
            ? `<div class="contact-detail"><a href="mailto:${esc(
                c.email,
              )}">${esc(c.email)}</a></div>`
            : ""
        }
        ${c.phone ? `<div class="contact-detail">${esc(c.phone)}</div>` : ""}
      </div>`;
          });
          html += "</div>";
        } else {
          html +=
            '<p class="text-muted text-sm mb">Inga kontakter hittades.</p>';
        }

        // Regulatory
        if (extracted.regulatoryDisclosure) {
          html +=
            '<h3 style="margin:20px 0 12px;">Regulatorisk information</h3>';
          html += `<div class="section-block" style="border-left-color:var(--yellow);"><p>${esc(
            extracted.regulatoryDisclosure,
          )}</p></div>`;
        }

        // Certified Adviser
        if (extracted.certifiedAdviser) {
          html += '<h3 style="margin:20px 0 12px;">Certified Adviser</h3>';
          html += `<div class="section-block" style="border-left-color:var(--green);"><p>${esc(
            extracted.certifiedAdviser,
          )}</p></div>`;
        }

        // About
        if (extracted.aboutCompany) {
          html += '<h3 style="margin:20px 0 12px;">Om bolaget</h3>';
          html += `<div class="section-block" style="border-left-color:var(--accent);"><p>${esc(
            extracted.aboutCompany,
          )}</p></div>`;
        }

        // Sections
        if (extracted.sections.length) {
          html += '<h3 style="margin:20px 0 12px;">Sektioner</h3>';
          extracted.sections.forEach((s) => {
            html += `<div class="section-block"><h4>${esc(
              s.heading,
            )}</h4><p>${esc(s.text)}</p></div>`;
          });
        }

        el.innerHTML = html;
      }

      // =============================================================================
      // TAB 4: MATCHES TABLE
      // =============================================================================
      function initMatches() {
        // Populate exchange filter
        const exchanges = new Set();
        MFN_MATCHES.forEach((m) => {
          (m.mfn_tickers || []).forEach((t) => {
            const ex = t.split(":")[0];
            if (ex !== "CAPA" && ex !== "XLON") exchanges.add(ex);
          });
        });
        const sel = document.getElementById("match-exchange");
        [...exchanges].sort().forEach((ex) => {
          sel.innerHTML += `<option value="${ex}">${ex}</option>`;
        });
        document.getElementById("match-count").textContent = MFN_MATCHES.length;
        filterMatches();
      }

      function filterMatches() {
        const q = document.getElementById("match-search").value.toLowerCase();
        const ex = document.getElementById("match-exchange").value;
        const src = document.getElementById("match-source").value;

        let filtered = MFN_MATCHES;
        if (q) {
          filtered = filtered.filter(
            (m) =>
              m.db_name.toLowerCase().includes(q) ||
              m.mfn_name.toLowerCase().includes(q) ||
              m.orgNumber.includes(q) ||
              m.mfn_slug.includes(q) ||
              (m.mfn_tickers || []).some((t) => t.toLowerCase().includes(q)),
          );
        }
        if (ex) {
          filtered = filtered.filter((m) =>
            (m.mfn_tickers || []).some((t) => t.startsWith(ex + ":")),
          );
        }
        if (src) {
          filtered = filtered.filter((m) => m.sources.includes(src));
        }

        document.getElementById("match-count").textContent = filtered.length;
        const tbody = document.getElementById("matches-tbody");
        tbody.innerHTML = filtered
          .map((m) => {
            const ticker = (m.mfn_tickers || [])
              .filter((t) => !t.startsWith("CAPA:") && !t.startsWith("XLON:"))
              .map(
                (t) =>
                  `<span class="badge badge-blue" style="font-size:10px">${esc(t)}</span>`,
              )
              .join(" ");
            return `<tr onclick="selectCompany('${escJs(m.mfn_slug)}', '${escJs(
              m.mfn_name,
            )}')">
      <td><strong>${esc(m.db_name)}</strong><br><span class="text-xs text-muted">${esc(m.mfn_slug)}</span></td>
      <td>${ticker || '<span class="text-muted">â€”</span>'}</td>
      <td><span class="badge ${getMatchTypeBadge(m.match_type)}" style="font-size:10px">${esc(m.match_type)}</span></td>
    </tr>`;
          })
          .join("");
      }

      // =============================================================================
      // TAB 5: TOOLS
      // =============================================================================
      async function fetchEntityCount() {
        const btn = document.getElementById("entity-count-btn");
        btn.disabled = true;
        btn.innerHTML =
          '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div> H\u00e4mtar...';
        const statsEl = document.getElementById("entity-stats");
        try {
          const res = await mfnFetch(
            "https://mfn.se/search/companies?query=&limit=5000",
          );
          const entities = await res.json();

          // Compute stats
          const exchangeCounts = {};
          let withOrg = 0,
            withISIN = 0,
            withLogo = 0;
          entities.forEach((e) => {
            (e.tickers || []).forEach((t) => {
              const ex = t.split(":")[0];
              exchangeCounts[ex] = (exchangeCounts[ex] || 0) + 1;
            });
            if ((e.local_refs || []).some((r) => r.startsWith("SE:")))
              withOrg++;
            if ((e.isins || []).length) withISIN++;
            if (e.brand_image_url) withLogo++;
          });

          const topExchanges = Object.entries(exchangeCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 8);

          statsEl.style.display = "block";
          statsEl.innerHTML = `
      <div class="stat-grid mb">
        <div class="stat-card"><div class="stat-value">${
          entities.length
        }</div><div class="stat-label">Totalt entiteter</div></div>
        <div class="stat-card"><div class="stat-value">${withOrg}</div><div class="stat-label">Med orgnummer (SE:)</div></div>
        <div class="stat-card"><div class="stat-value">${withISIN}</div><div class="stat-label">Med ISIN</div></div>
        <div class="stat-card"><div class="stat-value">${withLogo}</div><div class="stat-label">Med logotyp</div></div>
      </div>
      <h3 style="margin-bottom:8px;">Tickers per b\u00f6rs</h3>
      <div class="stat-grid">
        ${topExchanges
          .map(
            ([ex, count]) =>
              `<div class="stat-card"><div class="stat-value" style="font-size:22px;">${count}</div><div class="stat-label">${esc(
                ex,
              )}</div></div>`,
          )
          .join("")}
      </div>`;
        } catch (err) {
          statsEl.style.display = "block";
          statsEl.innerHTML = `<div class="error-msg">${esc(
            err.message,
          )}</div>`;
        } finally {
          btn.disabled = false;
          btn.textContent = "H\u00e4mta alla entiteter";
        }
      }

      function generateFeedUrls() {
        const slug = document.getElementById("feed-slug-input").value.trim();
        if (!slug) return;
        const el = document.getElementById("feed-urls");
        const urls = [
          {
            label: "JSON (f\u00f6retag)",
            url: `https://mfn.se/all/a/${slug}.json`,
          },
          { label: "RSS 2.0", url: `https://mfn.se/all/a/${slug}.rss` },
          { label: "Atom", url: `https://mfn.se/all/a/${slug}.atom` },
          { label: "XML", url: `https://mfn.se/all/a/${slug}.xml` },
          { label: "JSON (nordiskt)", url: `https://mfn.se/all/s/nordic.json` },
          { label: "RSS (nordiskt)", url: `https://mfn.se/all/s/nordic.rss` },
        ];
        el.innerHTML =
          '<div class="flex-col gap-sm mt">' +
          urls
            .map(
              (u) =>
                `<div class="url-output"><a href="${esc(
                  u.url,
                )}" target="_blank">${esc(u.label)}: ${esc(
                  u.url,
                )}</a><button class="btn btn-sm btn-secondary" onclick="navigator.clipboard.writeText('${esc(
                  u.url,
                )}');this.textContent='Kopierad!';setTimeout(()=>this.textContent='Kopiera',1500)">Kopiera</button></div>`,
            )
            .join("") +
          "</div>";
      }

      function buildStorageUrl() {
        const url = document.getElementById("storage-url-input").value.trim();
        if (!url) return;
        const size = document.getElementById("storage-size").value;
        const el = document.getElementById("storage-result");
        let finalUrl = url;
        if (size) {
          const sep = url.includes("?") ? "&" : "?";
          finalUrl = `${url}${sep}size=${size}`;
        }
        el.innerHTML = `
    <div class="url-output mt">
      <a href="${esc(finalUrl)}" target="_blank">${esc(finalUrl)}</a>
      <button class="btn btn-sm btn-secondary" onclick="navigator.clipboard.writeText('${esc(
        finalUrl,
      )}');this.textContent='Kopierad!';setTimeout(()=>this.textContent='Kopiera',1500)">Kopiera</button>
    </div>
    <img class="image-preview" src="${esc(
      finalUrl,
    )}" alt="Forhandsgranskning" onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
    <p class="text-sm text-muted mt-sm" style="display:none;">Kunde inte ladda bilden. Kontrollera att URL:en \u00e4r korrekt.</p>`;
      }

      function connectWebSocket() {
        if (wsConnection) return; // already connected

        updateWsUI("connecting");

        try {
          wsConnection = new WebSocket("wss://mfn.se/all/s/nordic");

          wsConnection.onopen = () => {
            updateWsUI("connected");
            addWsLog("Ansluten!", "var(--green)");
            document.getElementById("live-indicator").style.display = "";
          };

          wsConnection.onmessage = (event) => {
            const data = event.data;
            // MFN sends HTML fragments â€” try to extract title and entity
            const titleMatch =
              data.match(/<[^>]*class="[^"]*title[^"]*"[^>]*>([^<]+)/i) ||
              data.match(/<a[^>]*>([^<]{10,})</);
            const title = titleMatch
              ? titleMatch[1].trim()
              : "(nytt meddelande)";
            addWsLog(title, "var(--text)");

            // Try to parse as JSON for live feed injection
            try {
              const item = JSON.parse(data);
              if (item && item.news_id) {
                handleLiveItem(item);
              }
            } catch (e) {
              // HTML fragment â€” just log it
            }
          };

          wsConnection.onclose = (event) => {
            updateWsUI("disconnected");
            document.getElementById("live-indicator").style.display = "none";
            addWsLog(
              `Fr\u00e5nkopplad (kod: ${event.code})`,
              "var(--text-muted)",
            );
            wsConnection = null;
            // Auto-reconnect after 5s (or 0.5s if server requested)
            const delay = event.code === 3000 ? 500 : 5000;
            if (event.code === 3000) {
              addWsLog(
                "Server beg\u00e4rde snabb \u00e5teranslutning...",
                "var(--yellow)",
              );
            }
            setTimeout(connectWebSocket, delay);
          };

          wsConnection.onerror = () => {
            addWsLog("Anslutningsfel", "var(--red)");
          };
        } catch (err) {
          updateWsUI("disconnected");
          addWsLog("Kunde inte ansluta: " + err.message, "var(--red)");
          // Retry in 10s
          setTimeout(connectWebSocket, 10000);
        }
      }

      function toggleWebSocket() {
        if (wsConnection) {
          wsConnection.close();
          wsConnection = null;
          updateWsUI("disconnected");
          document.getElementById("live-indicator").style.display = "none";
        } else {
          connectWebSocket();
        }
      }

      function handleLiveItem(item) {
        // Check if this item is from a watched company
        const isWatched =
          watchedEntityIds.has(item.author?.entity_id) ||
          watchedSlugs.has(item.author?.slug);

        if (watchedFeedMode && isWatched) {
          // Check for duplicate
          if (!allFeedItems.some((i) => i.news_id === item.news_id)) {
            allFeedItems.unshift(item);
            applyFilters();
            // Flash animation on new item
            requestAnimationFrame(() => {
              const first = document.querySelector(".news-item");
              if (first) first.classList.add("news-item-new");
            });
          }
        }

        // Update badge if not viewing feed tab
        const feedTab = document.getElementById("tab-feed");
        if (!feedTab?.classList.contains("active") && isWatched) {
          liveNewItems++;
          updateFeedBadge();
        }
      }

      function updateWsUI(state) {
        const dot = document.getElementById("ws-dot");
        const text = document.getElementById("ws-status-text");
        const btn = document.getElementById("ws-connect-btn");
        if (!dot) return; // tools tab not initialized yet
        dot.className = "ws-dot";
        if (state === "connected") {
          dot.classList.add("connected");
          text.textContent = "Ansluten";
          btn.textContent = "Koppla fr\u00e5n";
        } else if (state === "connecting") {
          dot.classList.add("connecting");
          text.textContent = "Ansluter...";
          btn.disabled = true;
          setTimeout(() => (btn.disabled = false), 2000);
        } else {
          text.textContent = "Fr\u00e5nkopplad";
          btn.textContent = "Anslut";
        }
      }

      function addWsLog(msg, color) {
        const log = document.getElementById("ws-log");
        if (!log) return;
        log.style.display = "block";
        const time = new Date().toLocaleTimeString("sv-SE");
        const div = document.createElement("div");
        div.className = "ws-item";
        div.innerHTML = `<span class="ws-time">${time}</span> <span class="ws-title" style="color:${color}">${esc(
          msg,
        )}</span>`;
        log.insertBefore(div, log.firstChild);
        // Cap at 100 entries
        while (log.children.length > 100) log.removeChild(log.lastChild);
      }

      // =============================================================================
      // INIT
      // =============================================================================
      initMatches();

      // Detect file:// protocol and show CORS warning
      if (window.location.protocol === "file:") {
        document.getElementById("cors-banner").style.display = "block";
      }

      // Auto-load watched companies feed on startup
      loadWatchedFeed();

      // Auto-connect WebSocket for live updates
      connectWebSocket();
    </script>
  </body>
</html>
